<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»“åº“åº“å­˜ç›˜ç‚¹å·¥å…· (å®Œæ•´åŠŸèƒ½ç‰ˆ)</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* å…¨å±€ç›’æ¨¡å‹ä¿®å¤ */
        * { box-sizing: border-box; }
        
        :root { --primary-color: #2563eb; --bg-color: #f3f4f6; --card-bg: #ffffff; --border-color: #e5e7eb; }
        
        body { font-family: "Microsoft YaHei", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-color); margin: 0; padding: 10px; color: #333; }
        
        .container { 
            max-width: 1200px; 
            width: 100%; 
            margin: 0 auto; 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
        }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--bg-color); padding-bottom: 15px; }
        h1 { margin: 0; font-size: 1.5rem; color: #1f2937; }
        
        /* æŒ‰é’®ç»„ */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; transition: opacity 0.2s; display: inline-flex; align-items: center; justify-content: center;}
        .btn-settings { background-color: #4b5563; color: white; user-select: none;} 
        .btn-primary { background-color: var(--primary-color); color: white; width: 100%; padding: 12px; margin-top: 20px; font-size: 1rem;}
        .btn-danger { background-color: #ef4444; color: white; padding: 6px 12px; font-size: 0.9rem; }
        .btn-warning { background-color: #f59e0b; color: white; width: 100%; padding: 10px; } 
        .btn-edit { background-color: #3b82f6; color: white; padding: 4px 8px; font-size: 0.8rem; }
        .btn-img-upload { background-color: #8b5cf6; color: white; padding: 4px 8px; font-size: 0.8rem; }
        .btn-save-mini { background-color: #10b981; color: white; padding: 4px 8px; font-size: 0.8rem; margin-left: 5px; }
        .btn-cancel-mini { background-color: #9ca3af; color: white; padding: 4px 8px; font-size: 0.8rem; margin-left: 5px; }
        .btn-continue { background-color: #64748b; color: white; padding: 6px 12px; font-size: 0.9rem; }
        .btn-cloud-load { background-color: #0ea5e9; color: white; margin-right: 10px; }
        
        .btn-more { background-color: #94a3b8; color: white; padding: 4px 10px; font-size: 0.9rem; margin-left: 5px; border-radius: 4px;}
        .action-menu { display: none; gap: 5px; align-items: center; }
        .action-menu.active { display: flex; animation: fadeIn 0.2s; }

        @keyframes fadeIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }

        /* å•†å“æ·»åŠ æŒ‰é’® */
        .btn-add { 
            background-color: #10b981; color: white; 
            height: auto; 
            white-space: nowrap; 
            flex-shrink: 0; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            padding: 0 20px;
        }
        
        .btn-save-cloud { background-color: #7c3aed; color: white; }
        
        .btn-close-green { background-color: #10b981; color: white; }
        .btn:hover { opacity: 0.9; }

        .form-group { margin-bottom: 0; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #1e40af; }
        
        select, input[type="text"], input[type="number"] { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        
        #brandSelect { background-color: #fff7ed; border: 2px solid #fed7aa; color: #9a3412; font-weight: bold; }
        #searchProduct { margin-bottom: 10px; border: 1px solid #3b82f6; background-color: #f0f9ff; }

        textarea.bulk-input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; font-size: 1rem; min-height: 80px; resize: vertical; font-family: inherit; }
        .edit-input { padding: 4px 8px !important; width: auto !important; flex: 1; margin-right: 5px; border: 1px solid #3b82f6 !important; outline: none; }
        .home-section { background-color: #eff6ff; border: 1px solid #bfdbfe; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        #inventorySection { display: none; }

        .inventory-list { 
            border: 1px solid #bfdbfe; 
            border-radius: 8px; 
            overflow: visible; 
            background: white; 
            height: auto;      
        }
        
        .inventory-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; border-bottom: 1px solid #bfdbfe; background: #fff; transition: background-color 0.2s; }
        .inventory-item:last-child { border-bottom: none; }
        .inventory-item:nth-child(even) { background-color: #f8fafc; }
        .inventory-item.has-data { background-color: #dcfce7 !important; }

        .prod-thumb { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 10px; border: 1px solid #ddd; background: #eee; cursor: zoom-in; }
        .prod-thumb-placeholder { width: 40px; height: 40px; display: inline-block; background: #f1f5f9; border-radius: 4px; margin-right: 10px; text-align: center; line-height: 40px; font-size: 12px; color: #ccc; }
        
        .setting-thumb { width: 30px; height: 30px; object-fit: cover; border-radius: 3px; margin: 0 8px; vertical-align: middle; border: 1px solid #ddd; cursor: zoom-in; }

        .item-info { display: flex; align-items: center; flex: 1; overflow: hidden; }
        .item-name { word-break: break-all; }
        
        .item-input { flex: 0 0 auto; display: flex; align-items: center; justify-content: flex-end; }
        .item-input input { width: 60px; text-align: center; border: 1px solid #cbd5e1; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; align-items: flex-start; justify-content: center; padding: 40px 0; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 700px; margin: 0 auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2); height: auto; overflow: visible; }
        
        .modal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; position: sticky; top: -30px; background: white; z-index: 10; padding-top: 10px; padding-bottom: 10px; border-bottom: 2px solid #f3f4f6;}
        
        #settingsTitle { cursor: grab; user-select: none; transition: color 0.3s; margin: 0; align-self: center;}
        #settingsTitle:active { cursor: grabbing; color: #2563eb; }

        .manage-section { border: 1px solid var(--border-color); padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .section-brand { background-color: #ffffff; border-color: #e5e7eb; }
        
        .section-product { 
            background-color: #FFF7ED; 
            border-color: #fed7aa; 
            border: 2px dashed #fed7aa; 
            display: none; 
        }
        
        .manage-section h3 { margin-top: 0; color: #4b5563; padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center;}

        .list-group { list-style: none; padding: 0; margin: 10px 0; max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; background: #fff;}
        .list-group li { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; border-bottom: 1px dashed #cbd5e1; cursor: grab; min-height: 48px; }
        .list-group li:active { cursor: grabbing; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .list-group li:last-child { border-bottom: none; }
        .drag-handle { margin-right: 8px; color: #94a3b8; cursor: grab; display: flex; align-items: center;}
        
        .brand-tags-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .brand-tag {
            background: #fff; border: 1px solid #cbd5e1; padding: 8px 15px; border-radius: 20px;
            cursor: pointer; user-select: none; transition: all 0.2s; font-weight: 500; color: #475569;
            display: flex; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); height: 38px; box-sizing: border-box;
        }
        .brand-tag:hover { border-color: var(--primary-color); color: var(--primary-color); transform: translateY(-2px); }
        .brand-tag.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3); }
        
        input.brand-input-tag {
            width: 3.5em !important; 
            height: 38px !important;
            padding: 0 !important;
            text-align: center;
            border: 2px dashed #cbd5e1 !important; 
            border-radius: 20px; 
            outline: none; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: #fff;
            cursor: pointer;
            color: #10b981;
            font-weight: bold;
            font-size: 1.5rem;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        input.brand-input-tag:focus { 
            width: 150px !important; 
            border-style: solid !important; 
            border-color: var(--primary-color) !important; 
            background: #fff; 
            text-align: left !important;
            padding: 0 15px !important;
            cursor: text;
            font-size: 1rem;
            font-weight: normal;
            color: #333;
        }
        
        input.brand-input-tag::placeholder { color: #10b981; opacity: 1; text-align: center; font-weight: bold; font-size: 1.5rem; transform: translateY(-2px);}
        input.brand-input-tag:focus::placeholder { color: transparent; }

        .item-actions-wrapper { display: flex; gap: 5px; align-items: center; }
        
        .li-content { display: flex; align-items: center; width: 100%; justify-content: space-between; }
        .text-wrapper { display: flex; align-items: center; flex: 1; overflow: hidden; cursor: pointer;} 
        .text-wrapper:hover .text-content { color: var(--primary-color); text-decoration: underline; }

        .flex-row { display: flex; gap: 10px; margin-top: 10px; align-items: stretch; }
        
        .empty-state { text-align: center; color: #64748b; padding: 20px; font-style: italic; }

        #imgModal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        #imgModalContent { max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
        
        #settingBrandSelect { display: none; }

        .close-confirm-area {
            display: none; 
            background-color: #fff7ed;
            border: 1px solid #fed7aa;
            padding: 10px;
            border-radius: 8px;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            animation: fadeIn 0.3s;
        }
        .close-confirm-text {
            color: #c2410c;
            font-size: 0.9rem;
            font-weight: bold;
            text-align: right;
            margin-bottom: 5px;
        }
        .close-confirm-btns {
            display: flex;
            gap: 8px;
            flex-wrap: wrap; /* å…è®¸å°å±æ¢è¡Œ */
            justify-content: flex-end;
        }
        
        .inline-confirm-wrapper {
            display: none; 
            align-items: center;
            gap: 5px;
            background: #fee2e2;
            padding: 2px 5px;
            border-radius: 4px;
            border: 1px solid #fca5a5;
        }
        .inline-confirm-text {
            font-size: 0.8rem;
            color: #dc2626;
            font-weight: bold;
            white-space: nowrap;
        }
        
        #clearWrapper { margin-top: 10px; }
        #clearConfirmArea {
            align-items: center; 
            background-color: #fef2f2;
            border-color: #fca5a5;
        }

        /* æ–°å¢ï¼šæç¤ºæ¡†ä¸ç‰ˆæœ¬åˆ—è¡¨æ ·å¼ */
        .alert-box {
            display: none;
            background-color: #fff7ed; border: 2px solid #fed7aa;
            padding: 15px; border-radius: 8px; margin-bottom: 20px;
            animation: fadeIn 0.3s;
            flex-direction: column; gap: 10px;
        }
        .alert-title { color: #c2410c; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .alert-actions { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }
        .btn-revert { background-color: #f59e0b; color: white; }
        .btn-cancel { background-color: #94a3b8; color: white; }
        
        .version-list { list-style: none; padding: 0; margin: 0; }
        .version-item { 
            padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .version-item:hover { background-color: #f0f9ff; }
        .version-tag { font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; }
        .tag-latest { background: #dcfce7; color: #166534; }
        .tag-history { background: #f1f5f9; color: #64748b; }
        #versionSelectModal { z-index: 2000; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ“¦ åº“å­˜ç›˜ç‚¹å·¥å…· (å®Œæ•´ç‰ˆ)</h1>
        <button class="btn btn-settings" onclick="openSettings()">âš™ï¸ è®¾ç½®</button>
    </header>

    <div class="home-section">
        <div class="form-group">
            <label for="brandSelect">1. é€‰æ‹©å“ç‰Œ <span style="font-weight:normal; font-size:0.8rem; color:#9ca3af">(è‡ªåŠ¨ä¿å­˜ï¼Œéšæ„åˆ‡æ¢)</span></label>
            <select id="brandSelect" onchange="switchBrand()"><option value="">-- è¯·é€‰æ‹©å“ç‰Œ --</option></select>
        </div>
    </div>

    <div id="inventorySection" class="home-section" style="display: none;">
        <label>2. ç›˜ç‚¹æ•°é‡</label>
        
        <input type="text" id="searchProduct" placeholder="ğŸ” æœç´¢å•†å“åç§°..." oninput="filterProducts()">

        <div class="inventory-list" id="productList">
            <div class="empty-state">ğŸ‘ˆ è¯·å…ˆåœ¨ä¸Šæ–¹é€‰æ‹©ä¸€ä¸ªå“ç‰Œ</div>
        </div>
    </div>

    <button class="btn btn-primary" onclick="exportAllBrands()">ğŸ“¥ å¯¼å‡ºç›˜ç‚¹è¡¨ (Excel)</button>
    
    <div id="clearWrapper">
        <button id="preClearBtn" class="btn btn-warning" onclick="showClearConfirm()">ğŸ—‘ï¸ æ¸…ç©º (å¼€å§‹æ–°ç›˜ç‚¹)</button>
        
        <div id="clearConfirmArea" class="close-confirm-area">
            <div class="close-confirm-text" style="text-align: center; width: 100%; color: #dc2626;">
                âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²å¡«å†™çš„æ•°é‡å—ï¼Ÿ<br>åŒæ—¶ä¼šæ¸…ç©ºæœ¬åœ°ç¼“å­˜ï¼
            </div>
            <div class="close-confirm-btns">
                <button class="btn btn-danger" onclick="executeClear()">ç¡®è®¤æ¸…ç©º</button>
                <button class="btn btn-cancel-mini" style="padding: 8px 16px; font-size: 0.9rem;" onclick="cancelClear()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
</div>

<div id="settingsModal" class="modal" style="display: none;">
    <div class="modal-content">
        
        <div id="unsavedAlert" class="alert-box">
            <div class="alert-title">âš ï¸ æ£€æµ‹åˆ°é…ç½®æœ‰æ–°çš„æ”¹åŠ¨ï¼Œæ˜¯å¦ä¿å­˜åˆ°äº‘ç«¯ï¼Ÿ</div>
            <div class="alert-actions">
                <button class="btn btn-cancel" onclick="forceCloseSettings()">ğŸ  è¿”å›ä¸»é¡µ (æš‚ä¸ä¿å­˜)</button>
                <button class="btn btn-revert" onclick="showVersionSelector()">ğŸ”„ æ¢å¤/åŠ è½½äº‘ç«¯</button>
                <button class="btn btn-save-cloud" onclick="saveSettingsToCloud(true)">â˜ï¸ ä¿å­˜åˆ°äº‘ç«¯</button>
            </div>
        </div>

        <div class="modal-header">
            <h2 id="settingsTitle" draggable="true">âš™ï¸ è®¾ç½®</h2>
            
            <div style="display: flex; align-items: center;">
                <button class="btn btn-cloud-load" onclick="showVersionSelector()">â˜ï¸ åŠ è½½é…ç½®</button>
                <button id="defaultCloseBtn" class="btn btn-close-green" onclick="checkAndClose()">ğŸ’¾ ä¿å­˜ / å…³é—­</button>
            </div>
        </div>

        <div class="manage-section section-brand">
            <h3>ğŸ·ï¸ å“ç‰Œåˆ—è¡¨</h3>
            
            <div id="brandTags" class="brand-tags-container"></div>
            <div style="font-size: 0.8rem; color: #9ca3af; margin-top: 10px;">æç¤ºï¼šç‚¹å‡» "+" è¾“å…¥æ–°å“ç‰Œå›è½¦æ·»åŠ ï¼Œæ‹–åŠ¨å¯æ’åº</div>
        </div>

        <div class="manage-section section-product" id="productManageSection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #fed7aa; padding-bottom: 10px; margin-bottom: 10px;">
                <h3 style="margin:0; padding:0; border:none;"><span id="currentSettingBrandName" style="color:#2563eb"></span></h3>
                
                <div class="item-actions-wrapper">
                    <div id="brandDefaultActions" style="display: block;">
                         <button class="btn btn-more" onclick="toggleActionMenu(this)" style="display: inline-block;">âš™ï¸</button>
                         <div class="action-menu" style="display: none;">
                             <button class="btn btn-edit" onclick="renameCurrentBrand()">âœï¸ é‡å‘½åå“ç‰Œ</button>
                             <button class="btn btn-danger" onclick="showDeleteBrandConfirm()">ğŸ—‘ï¸ åˆ é™¤å“ç‰Œ</button>
                             <button class="btn btn-cancel-mini" onclick="closeActionMenu(this)">â–¶ï¸</button>
                         </div>
                    </div>
                    
                    <div id="brandDeleteConfirm" class="inline-confirm-wrapper" style="display: none;">
                        <button class="btn btn-danger" onclick="confirmDeleteBrand()">æ˜¯</button>
                        <button class="btn btn-cancel-mini" onclick="cancelDeleteBrand()">å¦</button>
                        <span class="inline-confirm-text">ç¡®å®šåˆ é™¤æ­¤å“ç‰Œ?</span>
                    </div>
                </div>
            </div>

            <select id="settingBrandSelect" onchange="loadProductsForSetting()"></select>
            
            <ul id="productListManage" class="list-group"></ul>
            
            <div class="flex-row">
                <textarea id="newProductName" class="bulk-input" placeholder="è¾“å…¥å•†å“åç§° æ”¯æŒæ‰¹é‡æ·»åŠ ï¼šä¸€è¡Œä¸€ä¸ªå•†å“"></textarea>
                <button class="btn btn-add" onclick="addProduct()">æ·»åŠ <br>å•†å“</button>
            </div>
        </div>
    </div>
</div>

<div id="versionSelectModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <h3>ğŸ•’ é€‰æ‹©è¦åŠ è½½çš„é…ç½®ç‰ˆæœ¬</h3>
        <ul id="versionList" class="version-list">
            </ul>
        <button class="btn btn-cancel" style="width:100%; margin-top:15px;" onclick="document.getElementById('versionSelectModal').style.display='none'">å–æ¶ˆ</button>
    </div>
</div>

<div id="imgModal" onclick="this.style.display='none'">
    <img id="imgModalContent">
</div>
<input type="file" id="hiddenFileInput" accept="image/*" style="display:none">

<script>
    // ==========================================
    // âš ï¸ è¯·åœ¨æ­¤å¤„å¡«å…¥æ‚¨çš„ Supabase é…ç½®ä¿¡æ¯
    // ==========================================
    const SUPABASE_URL = 'https://xlutfzstdxltvasnjmzq.supabase.co'; // è¯·åœ¨æ­¤å¡«å†™
    const SUPABASE_KEY = 'sb_publishable_bevWIETQac-lS6wQ7OnUnQ_DGbMmYvu';     // è¯·åœ¨æ­¤å¡«å†™
    
    // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
    let supabaseClient = null;
    if (typeof window.supabase !== 'undefined' && SUPABASE_URL.indexOf('YOUR_') === -1) {
        try {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch(e) {
            console.error("Supabase åˆå§‹åŒ–å¤±è´¥:", e);
        }
    }

    // å…¨å±€æ•°æ®å˜é‡
    let inventoryData = {};
    let inventoryImages = {};
    let sessionCounts = {};
    const STORAGE_KEY = 'inventory_session_counts';

    // äº‘ç«¯åŒæ­¥çŠ¶æ€ (Pro åŠŸèƒ½)
    let remoteFullData = { active: null, history: [] }; 
    let lastSyncedHash = "";

    let currentBrand = "";
    let currentSettingBrand = "";
    let brandSortable = null;
    let productSortable = null;
    let isAddingBrandLock = false;

    // åˆå§‹åŒ–
    window.onload = function() {
        const savedSession = localStorage.getItem(STORAGE_KEY);
        if (savedSession) {
            try { sessionCounts = JSON.parse(savedSession); } catch(e) {}
        }
        
        renderBrandSelects();
        
        // è‡ªåŠ¨åŠ è½½æœ€æ–°
        if (supabaseClient) {
            silentLoadLatest();
        } else {
            console.log("Supabase æœªé…ç½®ï¼Œè¿è¡Œåœ¨æœ¬åœ°ç¦»çº¿æ¨¡å¼");
        }
        
        document.getElementById('hiddenFileInput').addEventListener('change', handleFileSelect);
    };

    // ==========================================
    // æ ¸å¿ƒï¼šä¿å­˜ä¸å…³é—­é€»è¾‘ (Diff Check)
    // ==========================================
    
    function checkAndClose() {
        // è®¡ç®—å½“å‰æ•°æ®çš„ Hash
        const currentHash = JSON.stringify({ d: inventoryData, i: inventoryImages });
        
        if (currentHash === lastSyncedHash) {
            forceCloseSettings();
        } else {
            const alertBox = document.getElementById('unsavedAlert');
            alertBox.style.display = 'flex';
            document.querySelector('#settingsModal .modal-content').scrollTop = 0;
        }
    }

    function forceCloseSettings() {
        document.getElementById('settingsModal').style.display = 'none';
        document.getElementById('unsavedAlert').style.display = 'none';
        
        // å¦‚æœå½“å‰å“ç‰Œè¢«åˆ æˆ–æ”¹åï¼Œåˆ·æ–°ä¸»ç•Œé¢
        renderBrandSelects();
        if(currentBrand && !inventoryData[currentBrand]) {
            currentBrand = "";
            document.getElementById('brandSelect').value = "";
            toggleInventorySection();
        } else if (currentBrand) {
            loadProducts(); // åˆ·æ–°åˆ—è¡¨åå­—å¯èƒ½å˜äº†
        }
    }

    // ==========================================
    // æ ¸å¿ƒï¼šäº‘ç«¯äº¤äº’ (æ”¯æŒç‰ˆæœ¬æ§åˆ¶)
    // ==========================================

    async function silentLoadLatest() {
        try {
            const { data } = await supabaseClient
                .from('hysl-ckpd-data')
                .select('setting_value')
                .eq('setting_key', 'main_data')
                .single();

            if (data && data.setting_value) {
                processRemoteData(data.setting_value);
                // é¦–æ¬¡åŠ è½½åº”ç”¨æ•°æ®
                applyDataToApp(remoteFullData.active.data);
                lastSyncedHash = JSON.stringify({ d: inventoryData, i: inventoryImages });
            }
        } catch (e) { console.error("Auto load failed", e); }
    }

    function processRemoteData(jsonValue) {
        if (jsonValue.active && Array.isArray(jsonValue.history)) {
            remoteFullData = jsonValue;
        } else {
            // æ—§æ•°æ®å…¼å®¹
            remoteFullData = {
                active: { time: new Date().toLocaleString(), data: jsonValue },
                history: []
            };
        }
    }

    async function showVersionSelector() {
        if(!supabaseClient) return alert("è¯·å…ˆé…ç½®æ•°æ®åº“");
        
        const btn = document.querySelector('.btn-cloud-load');
        const oldText = btn.innerText;
        btn.innerText = "â³";
        
        try {
            const { data, error } = await supabaseClient
                .from('hysl-ckpd-data')
                .select('setting_value')
                .eq('setting_key', 'main_data')
                .single();
                
            if (error) throw error;
            processRemoteData(data.setting_value);
            
            const list = document.getElementById('versionList');
            list.innerHTML = '';
            
            // æœ€æ–°ç‰ˆ
            const active = remoteFullData.active || {};
            list.innerHTML += `
                <li class="version-item" onclick="confirmLoadVersion('active', 0)">
                    <div><strong>ğŸ“Œ æœ€æ–°ç‰ˆæœ¬</strong><br><small style="color:#888">${active.time || 'æœªçŸ¥æ—¶é—´'}</small></div>
                    <span class="version-tag tag-latest">Current</span>
                </li>`;
            
            // å†å²
            remoteFullData.history.forEach((hist, index) => {
                list.innerHTML += `
                    <li class="version-item" onclick="confirmLoadVersion('history', ${index})">
                        <div><strong>ğŸ•’ å†å²å­˜æ¡£ ${index + 1}</strong><br><small style="color:#888">${hist.time || 'æœªçŸ¥æ—¶é—´'}</small></div>
                        <span class="version-tag tag-history">Backup</span>
                    </li>`;
            });
            
            document.getElementById('versionSelectModal').style.display = 'flex';
        } catch(e) {
            alert("è·å–å¤±è´¥: " + e.message);
        } finally {
            btn.innerText = oldText;
        }
    }

    function confirmLoadVersion(type, index) {
        let targetData = null;
        if (type === 'active') targetData = remoteFullData.active.data;
        else targetData = remoteFullData.history[index].data;
        
        applyDataToApp(targetData);
        lastSyncedHash = JSON.stringify({ d: inventoryData, i: inventoryImages });
        
        document.getElementById('versionSelectModal').style.display = 'none';
        document.getElementById('unsavedAlert').style.display = 'none';
        
        if(document.getElementById('settingsModal').style.display === 'flex') {
            renderBrandTags();
            if(currentSettingBrand) loadProductsForSetting();
        }
        alert("âœ… å·²åŠ è½½é…ç½®ï¼");
    }

    function applyDataToApp(dataObj) {
        if(dataObj.inventoryData) inventoryData = dataObj.inventoryData;
        else inventoryData = dataObj; 
        
        if(dataObj.inventoryImages) inventoryImages = dataObj.inventoryImages;
        else inventoryImages = {};
        
        renderBrandSelects();
    }

    async function saveSettingsToCloud(closeAfterSave = false) {
        if (!supabaseClient) return alert("è¯·é…ç½® Key");
        
        const saveBtn = document.querySelector('.btn-save-cloud');
        const oldText = saveBtn.innerText;
        saveBtn.innerText = "â³ ä¿å­˜ä¸­...";
        saveBtn.disabled = true;

        try {
            const nowTime = new Date().toLocaleString();
            const newDataPackage = { inventoryData, inventoryImages };
            
            let newHistory = [...remoteFullData.history];
            if (remoteFullData.active) newHistory.unshift(remoteFullData.active);
            if (newHistory.length > 3) newHistory = newHistory.slice(0, 3);
            
            const finalPayload = {
                active: { time: nowTime, data: newDataPackage },
                history: newHistory
            };
            
            const { error } = await supabaseClient
                .from('hysl-ckpd-data')
                .upsert({ setting_key: 'main_data', setting_value: finalPayload });
                
            if (error) throw error;

            remoteFullData = finalPayload;
            lastSyncedHash = JSON.stringify({ d: inventoryData, i: inventoryImages });
            
            alert("âœ… ä¿å­˜æˆåŠŸï¼");
            
            if (closeAfterSave) {
                forceCloseSettings();
            } else {
                document.getElementById('unsavedAlert').style.display = 'none';
            }
        } catch (err) {
            alert("âŒ ä¿å­˜å¤±è´¥: " + err.message);
        } finally {
            saveBtn.innerText = oldText;
            saveBtn.disabled = false;
        }
    }

    // ==========================================
    // ä¸šåŠ¡é€»è¾‘ (UI / åŸåŠŸèƒ½æ¢å¤)
    // ==========================================

    function switchBrand() {
        const newBrand = document.getElementById('brandSelect').value;
        currentBrand = newBrand;
        document.getElementById('searchProduct').value = '';
        toggleInventorySection();
        loadProducts();
    }

    function toggleInventorySection() {
        const section = document.getElementById('inventorySection');
        if (currentBrand) {
            section.style.display = 'block';
        } else {
            section.style.display = 'none';
        }
    }

    function onQuantityChange(input, prodName) {
        if (!currentBrand) return;
        const qty = input.value;
        if (!sessionCounts[currentBrand]) sessionCounts[currentBrand] = {};
        if (qty !== "") {
            sessionCounts[currentBrand][prodName] = qty;
            input.closest('.inventory-item').classList.add('has-data');
        } else {
            if(sessionCounts[currentBrand][prodName]) delete sessionCounts[currentBrand][prodName];
            input.closest('.inventory-item').classList.remove('has-data');
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(sessionCounts));
    }

    function handleEnterKey(e, input) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const allInputs = Array.from(document.querySelectorAll('#productList input'));
            const idx = allInputs.indexOf(input);
            if (idx > -1 && idx < allInputs.length - 1) {
                allInputs[idx + 1].focus();
                allInputs[idx + 1].select();
            } else {
                input.blur();
            }
        }
    }

    function loadProducts() {
        const container = document.getElementById('productList');
        container.innerHTML = '';
        if (!currentBrand) return;
        
        const products = inventoryData[currentBrand] || [];
        if (products.length === 0) {
            container.innerHTML = '<div class="empty-state">è¯¥å“ç‰Œä¸‹æš‚æ— å•†å“ï¼Œè¯·å»è®¾ç½®ä¸­æ·»åŠ </div>';
            return;
        }

        products.forEach((prod) => {
            const div = document.createElement('div');
            div.className = 'inventory-item';
            
            let val = "";
            if (sessionCounts[currentBrand] && sessionCounts[currentBrand][prod] !== undefined) {
                val = sessionCounts[currentBrand][prod];
                div.classList.add('has-data');
            }
            
            let imgHTML = '<div class="prod-thumb-placeholder">æ— å›¾</div>';
            if (inventoryImages[currentBrand] && inventoryImages[currentBrand][prod]) {
                const src = inventoryImages[currentBrand][prod];
                imgHTML = `<img src="${src}" class="prod-thumb" onclick="showBigImage('${src}')">`;
            }

            div.innerHTML = `
                <div class="item-info">
                    ${imgHTML}
                    <span class="item-name">${prod}</span>
                </div>
                <div class="item-input">
                    <input type="number" data-name="${prod}" min="0" placeholder="-" value="${val}" oninput="onQuantityChange(this, '${prod}')" onkeypress="handleEnterKey(event, this)">
                </div>
            `;
            container.appendChild(div);
        });
    }

    function filterProducts() {
        const filterText = document.getElementById('searchProduct').value.toLowerCase();
        const items = document.querySelectorAll('.inventory-item');
        items.forEach(item => {
            const name = item.querySelector('.item-name').textContent.toLowerCase();
            if (name.includes(filterText)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    function showClearConfirm() {
        document.getElementById('preClearBtn').style.display = 'none';
        document.getElementById('clearConfirmArea').style.display = 'flex';
    }

    function cancelClear() {
        document.getElementById('clearConfirmArea').style.display = 'none';
        document.getElementById('preClearBtn').style.display = 'block';
    }

    function executeClear() {
        sessionCounts = {};
        localStorage.clear();
        if(currentBrand) loadProducts();
        cancelClear();
        alert("å·²æ¸…ç©ºï¼Œå¯ä»¥å¼€å§‹æ–°çš„ç›˜ç‚¹ã€‚");
    }

    function exportAllBrands() {
        if (typeof XLSX === 'undefined') return alert("âŒ é”™è¯¯ï¼šæ’ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢ã€‚");
        
        const brandsToExport = Object.keys(sessionCounts);
        const validBrands = brandsToExport.filter(brand => {
            const dataObj = sessionCounts[brand];
            return dataObj && Object.values(dataObj).some(v => v !== "");
        });

        if (validBrands.length === 0) {
            return alert("âš ï¸ å°šæœªå¡«å†™ä»»ä½•ç›˜ç‚¹æ•°æ®ï¼Œæ— æ³•å¯¼å‡ºã€‚\n\nå³ä½¿é€‰æ‹©äº†å“ç‰Œï¼Œå¦‚æœæ‰€æœ‰å•†å“æ•°é‡éƒ½ä¸ºç©ºï¼Œä¹Ÿä¸ä¼šå¯¼å‡ºã€‚");
        }

        try {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([]);
            
            const now = new Date();
            const dateShort = (now.getMonth() + 1) + "/" + now.getDate();
            
            let startCol = 0;
            let maxRows = 0;
            const colsWidths = [];

            validBrands.forEach(brand => {
                const blockData = [];
                blockData.push([`${brand}(${dateShort})`, ""]);
                blockData.push(["", ""]);
                blockData.push(["å“å", "åº“å­˜"]);
                
                const allProds = inventoryData[brand] || [];
                allProds.forEach(prodName => {
                    let qty = "";
                    if (sessionCounts[brand] && sessionCounts[brand][prodName] !== undefined) {
                        qty = parseInt(sessionCounts[brand][prodName]);
                    }
                    blockData.push([prodName, qty]);
                });

                XLSX.utils.sheet_add_aoa(ws, blockData, { origin: { r: 0, c: startCol } });
                
                colsWidths[startCol] = { wch: 20 };
                colsWidths[startCol + 1] = { wch: 5 };
                colsWidths[startCol + 2] = { wch: 30 }; // spacer

                if (blockData.length > maxRows) maxRows = blockData.length;
                startCol += 3; 
            });

            ws['!cols'] = colsWidths;
            const rows = [];
            for(let i=0; i < maxRows; i++) rows.push({ hpx: 18 });
            ws['!rows'] = rows;
            ws['!merges'] = []; 

            XLSX.utils.book_append_sheet(wb, ws, "ç›˜ç‚¹æ±‡æ€»");
            const timeStr = now.getFullYear() + "-" + (now.getMonth()+1) + "-" + now.getDate();
            XLSX.writeFile(wb, `åº“å­˜ç›˜ç‚¹æ±‡æ€»_${timeStr}.xlsx`);
            
            sessionCounts = {};
            localStorage.removeItem(STORAGE_KEY);
            if(currentBrand) loadProducts();
            
            alert("âœ… å¯¼å‡ºæˆåŠŸï¼\n\næœ¬æ¬¡ç›˜ç‚¹å·²ç»“æŸï¼Œæ•°æ®å·²è‡ªåŠ¨æ¸…ç©ºã€‚");
        } catch (error) {
            console.error(error);
            alert("âŒ å¯¼å‡ºå¤±è´¥ï¼š" + error.message);
        }
    }

    // ==========================================
    // è®¾ç½®ç•Œé¢é€»è¾‘ (æ¢å¤åŸç‰ˆ UI)
    // ==========================================

    function openSettings() {
        document.getElementById('settingsModal').style.display = 'flex';
        document.getElementById('unsavedAlert').style.display = 'none';
        
        renderBrandTags();
        
        const brandListEl = document.getElementById('brandTags');
        if(!brandSortable && typeof Sortable !== 'undefined') {
            brandSortable = new Sortable(brandListEl, {
                animation: 150,
                ghostClass: 'blue-background-class',
                filter: '.brand-input-tag',
                preventOnFilter: false,
                onEnd: reorderBrands
            });
        }
        
        if(!currentSettingBrand) {
            document.getElementById('productManageSection').style.display = 'none';
        } else {
            selectSettingBrand(currentSettingBrand);
        }
    }

    function renderBrandSelects() {
        const brands = Object.keys(inventoryData);
        const mainSelect = document.getElementById('brandSelect');
        const settingSelect = document.getElementById('settingBrandSelect');
        const currentMainVal = mainSelect.value;
        
        let optionsHTML = '<option value="">-- è¯·é€‰æ‹©å“ç‰Œ --</option>';
        brands.forEach(b => {
            optionsHTML += `<option value="${b}">${b}</option>`;
        });
        
        mainSelect.innerHTML = optionsHTML;
        settingSelect.innerHTML = optionsHTML;
        
        if(brands.includes(currentMainVal)) mainSelect.value = currentMainVal;
        
        if(document.getElementById('settingsModal').style.display === 'flex') {
            renderBrandTags();
        }
        toggleInventorySection();
    }

    function renderBrandTags() {
        const container = document.getElementById('brandTags');
        container.innerHTML = '';
        
        Object.keys(inventoryData).forEach(brand => {
            const tag = document.createElement('div');
            tag.className = 'brand-tag';
            tag.innerText = brand;
            tag.setAttribute('data-brand', brand);
            if (brand === currentSettingBrand) tag.classList.add('active');
            tag.onclick = function() { selectSettingBrand(brand); };
            container.appendChild(tag);
        });
        
        const input = document.createElement('input');
        input.type = 'text';
        input.id = 'newBrandInput';
        input.className = 'brand-input-tag';
        input.placeholder = '+';
        input.addEventListener('keypress', function(e) { if (e.key === 'Enter') addBrand(); });
        input.addEventListener('blur', function() { addBrand(); });
        container.appendChild(input);
    }

    function selectSettingBrand(brand) {
        currentSettingBrand = brand;
        const sel = document.getElementById('settingBrandSelect');
        if(sel) sel.value = brand;
        
        const oldInput = document.getElementById('newBrandInput');
        let isFocus = oldInput ? (document.activeElement === oldInput) : false;
        
        renderBrandTags();
        if(isFocus) document.getElementById('newBrandInput')?.focus();

        if (brand) {
            document.getElementById('productManageSection').style.display = 'block';
            document.getElementById('currentSettingBrandName').innerText = brand;
            cancelDeleteBrand();
            loadProductsForSetting();
        } else {
            document.getElementById('productManageSection').style.display = 'none';
        }
    }

    function addBrand() {
        if(isAddingBrandLock) return;
        const input = document.getElementById('newBrandInput');
        if(!input) return;
        
        const name = input.value.trim();
        if (!name) return;
        if (Object.prototype.hasOwnProperty.call(inventoryData, name)) return alert("å“ç‰Œåç§°å·²å­˜åœ¨");
        
        isAddingBrandLock = true;
        inventoryData[name] = [];
        renderBrandSelects();
        renderBrandTags();
        selectSettingBrand(name);
        
        setTimeout(() => {
            document.getElementById('newBrandInput')?.focus();
            isAddingBrandLock = false;
        }, 300);
    }

    function showDeleteBrandConfirm() {
        document.getElementById('brandDefaultActions').style.display = 'none';
        document.getElementById('brandDeleteConfirm').style.display = 'flex';
    }

    function cancelDeleteBrand() {
        document.getElementById('brandDeleteConfirm').style.display = 'none';
        document.getElementById('brandDefaultActions').style.display = 'block';
        const menuBtn = document.querySelector('#brandDefaultActions .btn-more');
        const menu = document.querySelector('#brandDefaultActions .action-menu');
        menuBtn.style.display = 'inline-block';
        menu.style.display = 'none';
    }

    function confirmDeleteBrand() {
        const brand = currentSettingBrand;
        if (!brand) return;
        
        delete inventoryData[brand];
        if(inventoryImages[brand]) delete inventoryImages[brand];
        if(sessionCounts[brand]) delete sessionCounts[brand];
        
        currentSettingBrand = "";
        renderBrandSelects();
        renderBrandTags();
        document.getElementById('productManageSection').style.display = 'none';
        cancelDeleteBrand();
        
        if(currentBrand === brand) {
            currentBrand = "";
            document.getElementById('brandSelect').value = "";
            toggleInventorySection();
        }
    }

    function renameCurrentBrand() {
        const oldName = currentSettingBrand;
        if (!oldName) return;
        
        const newName = prompt("è¯·è¾“å…¥æ–°çš„å“ç‰Œåç§°:", oldName);
        if (newName && newName.trim() !== "" && newName !== oldName) {
            const finalName = newName.trim();
            if (inventoryData[finalName]) return alert("è¯¥å“ç‰Œåç§°å·²å­˜åœ¨ï¼");
            
            inventoryData[finalName] = inventoryData[oldName];
            delete inventoryData[oldName];
            
            if (inventoryImages[oldName]) {
                inventoryImages[finalName] = inventoryImages[oldName];
                delete inventoryImages[oldName];
            }
            if (sessionCounts[oldName]) {
                sessionCounts[finalName] = sessionCounts[oldName];
                delete sessionCounts[oldName];
            }
            
            if (currentBrand === oldName) currentBrand = finalName;
            renderBrandSelects();
            selectSettingBrand(finalName);
        }
    }

    function reorderBrands() {
        const tags = document.querySelectorAll('#brandTags .brand-tag');
        const newInventory = {};
        tags.forEach(tag => {
            const brandName = tag.getAttribute('data-brand');
            if (brandName && inventoryData[brandName]) newInventory[brandName] = inventoryData[brandName];
        });
        inventoryData = newInventory;
        renderBrandSelects();
    }

    // æ¢å¤äº§å“åˆ—è¡¨é€»è¾‘ (å«èœå•)
    function loadProductsForSetting() {
        const brand = currentSettingBrand;
        const list = document.getElementById('productListManage');
        if(productSortable) {
            productSortable.destroy();
            productSortable = null;
        }
        list.innerHTML = '';
        
        if (!brand || !inventoryData[brand]) {
            list.innerHTML = '<li style="color:#888; padding:10px;">è¯·å…ˆåœ¨ä¸Šæ–¹é€‰æ‹©ä¸€ä¸ªå“ç‰Œ</li>';
            return;
        }
        
        inventoryData[brand].forEach((prod, index) => {
            const li = document.createElement('li');
            li.setAttribute('data-prod', prod);
            
            let hasImg = (inventoryImages[brand] && inventoryImages[brand][prod]);
            let imgBtnStyle = hasImg ? "background-color: #22c55e;" : "";
            let imgBtnText = hasImg ? "ğŸ–¼ï¸" : "ğŸ–¼ï¸";
            let thumbTag = hasImg ? `<img src="${inventoryImages[brand][prod]}" class="setting-thumb" onclick="showBigImage('${inventoryImages[brand][prod]}')">` : '';
            
            li.innerHTML = `
                <div class="li-content">
                    <div class="text-wrapper" onclick="${hasImg ? `showBigImage('${inventoryImages[brand][prod]}')` : ''}">
                        <span class="drag-handle">â˜°</span>
                        ${thumbTag}
                        <span class="text-content">${prod}</span>
                    </div>
                    <div class="item-actions-wrapper">
                        <div class="action-menu-default">
                            <button class="btn btn-more" onclick="toggleActionMenu(this)">âš™ï¸</button>
                            <div class="action-menu">
                                <button class="btn btn-img-upload" style="${imgBtnStyle}" onclick="triggerUpload('${brand}', ${index})" title="ä¸Šä¼ /ä¿®æ”¹å›¾ç‰‡">${imgBtnText}</button>
                                <button class="btn btn-edit" onclick="enableProductEdit(this, '${brand}', ${index})" title="ç¼–è¾‘">âœï¸</button>
                                <button class="btn btn-danger" onclick="showDeleteProductConfirm(this)" title="åˆ é™¤">ğŸ—‘ï¸</button>
                                <button class="btn btn-cancel-mini" onclick="closeActionMenu(this)">â–¶ï¸</button>
                            </div>
                        </div>
                        
                        <div class="inline-confirm-wrapper">
                             <button class="btn btn-danger" onclick="confirmDeleteProduct('${brand}', ${index})">æ˜¯</button>
                             <button class="btn btn-cancel-mini" onclick="cancelDeleteProduct(this)">å¦</button>
                             <span class="inline-confirm-text">ç¡®å®šåˆ é™¤?</span>
                        </div>
                    </div>
                </div>
            `;
            list.appendChild(li);
        });

        if(typeof Sortable !== 'undefined') {
            productSortable = new Sortable(list, {
                animation: 150,
                handle: '.drag-handle',
                onEnd: function (evt) {
                    reorderProducts(brand);
                }
            });
        }
    }

    function reorderProducts(brand) {
        const lis = document.querySelectorAll('#productListManage li');
        const newProducts = [];
        lis.forEach(li => {
            const prod = li.getAttribute('data-prod');
            if(prod) newProducts.push(prod);
        });
        inventoryData[brand] = newProducts;
    }

    function addProduct() {
        const brand = currentSettingBrand;
        const inputVal = document.getElementById('newProductName').value;
        if (!brand) return alert("è¯·å…ˆé€‰æ‹©å“ç‰Œ");
        if (!inputVal.trim()) return alert("è¯·è¾“å…¥å•†å“åç§°");
        
        const newItems = inputVal.split('\n').map(item => item.trim()).filter(item => item !== "");
        newItems.forEach(name => {
            if (!inventoryData[brand].includes(name)) {
                inventoryData[brand].push(name);
            }
        });
        
        document.getElementById('newProductName').value = '';
        loadProductsForSetting();
    }

    function toggleActionMenu(btn) {
        const wrapper = btn.closest('.item-actions-wrapper');
        const menu = wrapper.querySelector('.action-menu');
        
        if (menu.style.display === 'flex') {
            menu.style.display = 'none';
            btn.style.display = 'inline-block';
        } else {
            document.querySelectorAll('.action-menu').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.inline-confirm-wrapper').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.btn-more').forEach(el => el.style.display = 'inline-block');
            document.querySelectorAll('.action-menu-default').forEach(el => el.style.display = 'block');
            
            menu.style.display = 'flex';
            btn.style.display = 'none';
        }
    }

    function closeActionMenu(closeBtn) {
        const wrapper = closeBtn.closest('.item-actions-wrapper');
        const menu = wrapper.querySelector('.action-menu');
        const triggerBtn = wrapper.querySelector('.btn-more');
        menu.style.display = 'none';
        triggerBtn.style.display = 'inline-block';
    }

    function showDeleteProductConfirm(btn) {
        const wrapper = btn.closest('.item-actions-wrapper');
        wrapper.querySelector('.action-menu-default').style.display = 'none';
        wrapper.querySelector('.inline-confirm-wrapper').style.display = 'flex';
    }

    function cancelDeleteProduct(btn) {
        const wrapper = btn.closest('.item-actions-wrapper');
        wrapper.querySelector('.inline-confirm-wrapper').style.display = 'none';
        wrapper.querySelector('.action-menu-default').style.display = 'block';
        const menuBtn = wrapper.querySelector('.btn-more');
        const menu = wrapper.querySelector('.action-menu');
        menuBtn.style.display = 'inline-block';
        menu.style.display = 'none';
    }

    function confirmDeleteProduct(brand, index) {
        const prodName = inventoryData[brand][index];
        if (sessionCounts[brand] && sessionCounts[brand][prodName]) delete sessionCounts[brand][prodName];
        if (inventoryImages[brand] && inventoryImages[brand][prodName]) delete inventoryImages[brand][prodName];
        
        inventoryData[brand].splice(index, 1);
        loadProductsForSetting();
    }

    function enableProductEdit(btn, brand, index) {
        const li = btn.closest('li');
        const textWrapper = li.querySelector('.text-wrapper');
        const textContent = li.querySelector('.text-content');
        const oldName = textContent.innerText;
        
        const input = document.createElement('input');
        input.type = 'text';
        input.value = oldName;
        input.className = 'edit-input';
        
        textWrapper.innerHTML = '';
        textWrapper.appendChild(input);
        textWrapper.onclick = null; 
        input.focus();
        closeActionMenu(btn);
        
        const saveEdit = () => {
            const newName = input.value.trim();
            if (newName && newName !== oldName) {
                inventoryData[brand][index] = newName;
                if (inventoryImages[brand] && inventoryImages[brand][oldName]) {
                    inventoryImages[brand][newName] = inventoryImages[brand][oldName];
                    delete inventoryImages[brand][oldName];
                }
                if (sessionCounts[brand] && sessionCounts[brand][oldName]) {
                    sessionCounts[brand][newName] = sessionCounts[brand][oldName];
                    delete sessionCounts[brand][oldName];
                }
            }
            loadProductsForSetting();
        };
        input.addEventListener('blur', saveEdit);
        input.addEventListener('keypress', (e) => { if (e.key === 'Enter') saveEdit(); });
    }

    // å›¾ç‰‡ä¸Šä¼ 
    let pendingUploadBrand = null;
    let pendingUploadIndex = null;

    function triggerUpload(brand, index) {
        pendingUploadBrand = brand;
        pendingUploadIndex = index;
        document.getElementById('hiddenFileInput').value = '';
        document.getElementById('hiddenFileInput').click();
        
        const lis = document.querySelectorAll('#productListManage li');
        if(lis[index]) {
            const closeBtn = lis[index].querySelector('.btn-cancel-mini');
            if(closeBtn) closeActionMenu(closeBtn);
        }
    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const base64 = e.target.result;
            const brand = pendingUploadBrand;
            const index = pendingUploadIndex;
            const prodName = inventoryData[brand][index];
            if (!inventoryImages[brand]) inventoryImages[brand] = {};
            inventoryImages[brand][prodName] = base64;
            loadProductsForSetting();
        };
        reader.readAsDataURL(file);
    }

    function showBigImage(src) {
        const modal = document.getElementById('imgModal');
        const img = document.getElementById('imgModalContent');
        img.src = src;
        modal.style.display = 'flex';
    }
</script>

</body>
</html>
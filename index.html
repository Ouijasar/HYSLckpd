<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº“å­˜ç›˜ç‚¹å·¥å…·</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/pinyin-pro@3.18.2/dist/index.js"></script>

    <style>
        * { box-sizing: border-box; }
        
        :root { --primary-color: #2563eb; --bg-color: #f3f4f6; --card-bg: #ffffff; --border-color: #e5e7eb; }
        
        body { font-family: "Microsoft YaHei", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-color); margin: 0; padding: 10px; color: #333; }
        
        .container { 
            max-width: 800px; 
            width: 100%; 
            margin: 0 auto; 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
        }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--bg-color); padding-bottom: 15px; }
        h1 { margin: 0; font-size: 1.5rem; color: #1f2937; }
        
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; transition: opacity 0.2s; display: inline-flex; align-items: center; justify-content: center;}
        .btn-settings { background-color: #4b5563; color: white; user-select: none;} 
        .btn-primary { background-color: var(--primary-color); color: white; width: 100%; padding: 12px; margin-top: 20px; font-size: 1rem;}
        
        .btn-export-big { 
            background-color: var(--primary-color); 
            color: white; 
            width: 100%; 
            padding: 16px; 
            margin-top: 20px; 
            font-size: 1.1rem; 
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(37, 99, 235, 0.3);
        }

        .btn-danger { background-color: #ef4444; color: white; padding: 6px 12px; font-size: 0.9rem; }
        .btn-warning { background-color: #f59e0b; color: white; width: 100%; padding: 10px; } 
        .btn-edit { background-color: #3b82f6; color: white; }
        .btn-img-upload { background-color: #8b5cf6; color: white; }
        .btn-save-mini { background-color: #10b981; color: white; }
        .btn-cancel-mini { background-color: #9ca3af; color: white; }
        .btn-continue { background-color: #64748b; color: white; }
        .btn-cloud-load { background-color: #0ea5e9; color: white; margin-right: 10px; }
        .btn-export-local { background-color: #8b5cf6; color: white; margin-right: 10px; } 
        .btn-import-local { background-color: #64748b; color: white; width: 100%; margin-top: 10px; border: 1px dashed #cbd5e1;} 
        .btn-log { background-color: #6366f1; color: white; font-size: 0.8rem; padding: 4px 8px; }
        .btn-apply { background-color: #10b981; color: white; font-size: 0.8rem; padding: 4px 12px; margin-right: 5px; }
        
        .btn-more { 
            background-color: #f3f4f6; 
            color: #4b5563; 
            padding: 4px 10px; 
            font-size: 1.1rem; 
            margin-left: 5px; 
            border-radius: 6px;
            font-weight: bold;
            line-height: 1;
            transition: all 0.2s;
        }
        .btn-more:hover { background-color: #e5e7eb; color: #111; }

        .btn-advanced { background-color: #64748b; color: white; width: 100%; padding: 12px; margin-top: 20px; border-radius: 8px;}

        .action-menu { display: none; gap: 5px; align-items: center; }
        
        .action-menu .btn, .action-menu-default .btn-more {
            width: 32px; height: 32px; padding: 0; font-size: 0.9rem; display: inline-flex; align-items: center; justify-content: center;
        }

        .btn-add { background-color: #10b981; color: white; height: auto; white-space: nowrap; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: bold; padding: 0 20px; }
        .btn-close-green { background-color: #10b981; color: white; transition: all 0.2s; }
        .btn-close-green.drag-over { transform: scale(1.1); box-shadow: 0 0 15px #3b82f6; background-color: #3b82f6; content: "å¯¼å‡ºæ€»æ—¥å¿—"; }
        .btn:hover { opacity: 0.9; }

        .form-group { margin-bottom: 0; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #1e40af; }
        
        select, input[type="text"], input[type="number"], input[type="password"] { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        
        #brandSelect { background-color: #fff7ed; border: 2px solid #fed7aa; color: #9a3412; font-weight: bold; }
        #searchProduct { margin-bottom: 10px; border: 1px solid #3b82f6; background-color: #f0f9ff; }

        textarea.bulk-input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; font-size: 1rem; min-height: 80px; resize: vertical; font-family: inherit; }
        .edit-input { padding: 4px 8px !important; width: auto !important; flex: 1; margin-right: 5px; border: 1px solid #3b82f6 !important; outline: none; }
        .home-section { background-color: #eff6ff; border: 1px solid #bfdbfe; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        #inventorySection { display: none; }

        .inventory-list { border: 1px solid #bfdbfe; border-radius: 8px; overflow: visible; background: white; height: auto; }
        .inventory-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; border-bottom: 1px solid #bfdbfe; background: #fff; transition: background-color 0.2s; }
        .inventory-item:last-child { border-bottom: none; }
        .inventory-item.has-data { background-color: #dcfce7 !important; }
        .inventory-item:nth-child(even) { background-color: #f8fafc; }

        .prod-thumb { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 10px; border: 1px solid #ddd; background: #eee; cursor: zoom-in; }
        .prod-thumb-placeholder { width: 40px; height: 40px; display: inline-block; background: #f1f5f9; border-radius: 4px; margin-right: 10px; text-align: center; line-height: 40px; font-size: 12px; color: #ccc; }
        
        .setting-thumb { width: 30px; height: 30px; object-fit: cover; border-radius: 3px; margin: 0 8px; vertical-align: middle; border: 1px solid #ddd; cursor: zoom-in; }

        .item-info { display: flex; align-items: center; flex: 1; overflow: hidden; }
        .item-name { word-break: break-all; }
        
        .item-input { flex: 0 0 auto; display: flex; align-items: center; justify-content: flex-end; }
        .item-input input { width: 60px; text-align: center; border: 1px solid #cbd5e1; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; align-items: flex-start; justify-content: center; padding: 40px 0; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 700px; margin: 0 auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2); height: auto; overflow: visible; position: relative; }
        
        /* ä¿®æ”¹ç‚¹4ï¼šä¿®å¤è®¾ç½®é¡µHeaderçš„UI Bug */
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; /* ç¡®ä¿å‚ç›´å±…ä¸­ */
            margin-bottom: 20px; 
            
            /* ç²˜æ€§å®šä½ */
            position: sticky; 
            top: 0; 
            background: white; 
            z-index: 50; 
            
            /* è´Ÿè¾¹è·æŠµæ¶ˆçˆ¶å®¹å™¨Paddingï¼Œå®ç°å¸é¡¶æ— ç¼éš™ */
            margin-top: -30px;
            margin-left: -30px;
            margin-right: -30px;
            
            /* å†…éƒ¨è¡¥ç™½ */
            padding: 15px 30px;
            border-bottom: 2px solid #f3f4f6;
        }
        
        #settingsTitle { cursor: grab; user-select: none; transition: color 0.3s; margin: 0; align-self: center; display: flex; align-items: center;}
        #settingsTitle:active { cursor: grabbing; color: #2563eb; }

        .manage-section { border: 1px solid var(--border-color); padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .section-brand { background-color: #ffffff; border-color: #e5e7eb; }
        .section-product { background-color: #FFF7ED; border-color: #fed7aa; border: 2px dashed #fed7aa; display: none; }
        .manage-section h3 { margin-top: 0; color: #4b5563; padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center;}

        .list-group { list-style: none; padding: 0; margin: 10px 0; max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; background: #fff;}
        .list-group li { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; border-bottom: 1px dashed #cbd5e1; cursor: grab; min-height: 48px; }
        .list-group li:active { cursor: grabbing; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .list-group li:last-child { border-bottom: none; }
        .drag-handle { margin-right: 8px; color: #94a3b8; cursor: grab; display: flex; align-items: center;}
        
        .brand-tags-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .brand-tag { background: #fff; border: 1px solid #cbd5e1; padding: 8px 15px; border-radius: 20px; cursor: pointer; user-select: none; transition: all 0.2s; font-weight: 500; color: #475569; display: flex; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); height: 38px; box-sizing: border-box; }
        .brand-tag:hover { border-color: var(--primary-color); color: var(--primary-color); transform: translateY(-2px); }
        .brand-tag.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3); }
        
        input.brand-input-tag { width: 3.5em !important; height: 38px !important; padding: 0 !important; text-align: center; border: 2px dashed #cbd5e1 !important; border-radius: 20px; outline: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); background: #fff; cursor: pointer; color: #10b981; font-weight: bold; font-size: 1.5rem; line-height: 1; display: inline-flex; align-items: center; justify-content: center; }
        input.brand-input-tag:focus { width: 150px !important; border-style: solid !important; border-color: var(--primary-color) !important; background: #fff; text-align: left !important; padding: 0 15px !important; cursor: text; font-size: 1rem; font-weight: normal; color: #333; }
        input.brand-input-tag::placeholder { color: #10b981; opacity: 1; text-align: center; font-weight: bold; font-size: 1.5rem; transform: translateY(-2px);}
        input.brand-input-tag:focus::placeholder { color: transparent; }

        .item-actions-wrapper { display: flex; gap: 5px; align-items: center; }
        .li-content { display: flex; align-items: center; width: 100%; justify-content: space-between; }
        .text-wrapper { display: flex; align-items: center; flex: 1; overflow: hidden; cursor: pointer;} 
        .text-wrapper:hover .text-content { color: var(--primary-color); text-decoration: underline; }

        .flex-row { display: flex; gap: 10px; margin-top: 10px; align-items: stretch; }
        .empty-state { text-align: center; color: #64748b; padding: 20px; font-style: italic; }

        #imgModal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        #imgModalContent { max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
        
        #settingBrandSelect { display: none; }

        .close-confirm-area { display: none; background-color: #fff7ed; border: 1px solid #fed7aa; padding: 10px; border-radius: 8px; flex-direction: column; align-items: flex-end; gap: 8px; animation: fadeIn 0.3s; }
        .close-confirm-text { color: #c2410c; font-size: 0.9rem; font-weight: bold; text-align: right; margin-bottom: 5px; }
        .close-confirm-btns { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }
        
        .inline-confirm-wrapper { display: none; align-items: center; gap: 5px; background: #fee2e2; padding: 2px 5px; border-radius: 4px; border: 1px solid #fca5a5; }
        .inline-confirm-text { font-size: 0.8rem; color: #dc2626; font-weight: bold; white-space: nowrap; }
        
        #clearWrapper { margin-top: 10px; }
        #clearConfirmArea { align-items: center; background-color: #fef2f2; border-color: #fca5a5; }

        .alert-box { display: none; background-color: #fff7ed; border: 2px solid #fed7aa; padding: 15px; border-radius: 8px; margin-bottom: 20px; animation: fadeIn 0.3s; flex-direction: column; gap: 10px; }
        .alert-title { color: #c2410c; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .alert-actions { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }
        
        .btn-cancel { background-color: #94a3b8; color: white; }
        
        .version-list { list-style: none; padding: 0; margin: 0; }
        .version-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: default; }
        .version-item:hover { background-color: #f9f9f9; }
        .version-info { flex: 1; }
        .version-actions { display: flex; gap: 5px; align-items: center; }
        .version-tag { font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 4px;}
        .tag-latest { background: #dcfce7; color: #166534; }
        .tag-history { background: #f1f5f9; color: #64748b; }
        
        /* å †å å±‚çº§ç®¡ç† */
        /* ä¿®æ”¹ç‚¹2ï¼šLoader å±‚çº§æœ€é«˜ */
        #globalLoader { z-index: 9999; }
        #toastContainer { z-index: 9998; }
        #unsavedFloatBar { z-index: 9990; }
        #versionSelectModal, #logModal, #customDialogModal, #saveProcessModal, #advancedSettingsModal, #passwordCheckModal { z-index: 3000; }
        
        #logList { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; }
        #logList li { border-bottom: 1px solid #eee; padding: 10px; font-size: 0.9rem; }
        #logList .log-time { color: #888; font-size: 0.8rem; margin-bottom: 2px; }

        #toastContainer { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; gap: 10px; }
        .toast-msg { background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 25px; font-size: 0.9rem; animation: fadeUp 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 8px;}
        .toast-success { background: #10b981; }
        .toast-error { background: #ef4444; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .custom-dialog-content { max-width: 400px; width: 90%; text-align: center; }
        .dialog-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 15px; color: #333; }
        .dialog-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 20px; font-size: 1rem; }
        .dialog-btns { display: flex; gap: 10px; justify-content: center; width: 100%; align-items: center; }
        .dialog-btns button { flex: 1; min-width: 0; height: 40px; padding: 0 10px; margin: 0; display: flex; align-items: center; justify-content: center; }

        /* Loader Animation */
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .loading-container { padding: 40px; text-align: center; }
        .loading-text { font-size: 1.1rem; color: #555; margin-bottom: 20px; font-weight: bold;}

        /* é«˜çº§è®¾ç½®ç›¸å…³æ ·å¼ */
        .advanced-section { border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f8fafc; }
        .advanced-title { font-weight: bold; margin-bottom: 10px; display: block; color: #334155; }
        .password-row { display: flex; gap: 10px; }

        /* ä¿®æ”¹ç‚¹2ï¼šåˆå§‹å…¨å±åŠ è½½é®ç½© */
        #globalLoader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.95); 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            transition: opacity 0.3s;
        }

        /* ä¿®æ”¹ç‚¹3ï¼šåº•éƒ¨æœªä¿å­˜æç¤ºæ¡ */
        .unsaved-float-bar {
            display: none;
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 10px 20px;
            border-radius: 50px;
            align-items: center;
            gap: 15px;
            animation: slideUp 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            z-index: 9990; /* ç¡®ä¿åœ¨Modalä¹‹ä¸Š */
        }
        .unsaved-text { font-size: 0.9rem; font-weight: bold; color: #333; display: flex; align-items: center; gap: 6px;}
        @keyframes slideUp { from { transform: translate(-50%, 50px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

    </style>
</head>
<body>

<div id="globalLoader">
    <div class="spinner"></div>
    <div class="loading-text">åŠ è½½ä¸­...</div>
</div>

<div id="toastContainer"></div>

<div id="unsavedFloatBar" class="unsaved-float-bar">
    <div class="unsaved-text">âš ï¸ å·²ä¿®æ”¹é…ç½®ï¼Œæ˜¯å¦åŒæ­¥åˆ°äº‘ç«¯</div>
    <button class="btn btn-close-green" style="padding: 6px 15px; font-size: 0.9rem;" onclick="saveSettingsToCloud(false)">åŒæ­¥</button>
</div>

<div class="container">
    <header>
        <h1>ğŸ“¦ åº“å­˜ç›˜ç‚¹å·¥å…·</h1>
        <button class="btn btn-settings" onclick="checkPasswordAndOpen()">âš™ï¸ è®¾ç½®</button>
    </header>

    <div class="home-section">
        <div class="form-group">
            <label for="brandSelect">1. é€‰æ‹©å“ç‰Œ <span style="font-weight:normal; font-size:0.8rem; color:#9ca3af">(è‡ªåŠ¨ä¿å­˜ï¼Œéšæ„åˆ‡æ¢)</span></label>
            <select id="brandSelect" onchange="switchBrand()"><option value="">-- è¯·é€‰æ‹©å“ç‰Œ --</option></select>
        </div>
    </div>

    <div id="inventorySection" class="home-section" style="display: none;">
        <label>2. ç›˜ç‚¹æ•°é‡</label>
        
        <input type="text" id="searchProduct" placeholder="ğŸ” æœç´¢å•†å“åç§°..." oninput="filterProducts()">

        <div class="inventory-list" id="productList">
            <div class="empty-state">ğŸ‘ˆ è¯·å…ˆåœ¨ä¸Šæ–¹é€‰æ‹©ä¸€ä¸ªå“ç‰Œ</div>
        </div>
    </div>

    <button class="btn btn-export-big" onclick="exportAllBrands()">ğŸ“¥ å¯¼å‡ºç›˜ç‚¹è¡¨ (Excel)</button>
    
    <div id="clearWrapper">
        <button id="preClearBtn" class="btn btn-warning" onclick="showClearConfirm()">ğŸ—‘ï¸ æ¸…ç©º (å¼€å§‹æ–°ç›˜ç‚¹)</button>
        
        <div id="clearConfirmArea" class="close-confirm-area">
            <div class="close-confirm-text" style="text-align: center; width: 100%; color: #dc2626;">
                âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²å¡«å†™çš„æ•°é‡å—ï¼Ÿ<br>åŒæ—¶ä¼šæ¸…ç©ºæœ¬åœ°ç¼“å­˜ï¼
            </div>
            <div class="close-confirm-btns">
                <button class="btn btn-danger" onclick="executeClear()">ç¡®è®¤æ¸…ç©º</button>
                <button class="btn btn-cancel-mini" style="padding: 8px 16px; font-size: 0.9rem;" onclick="cancelClear()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
</div>

<div id="settingsModal" class="modal" style="display: none;">
    <div class="modal-content">
        
        <div class="modal-header">
            <h2 id="settingsTitle" draggable="true" title="æŒ‰ä½æ‹–æ‹½åˆ°å³ä¾§æŒ‰é’®å¯å¯¼å‡ºæ“ä½œæ—¥å¿—">âš™ï¸ è®¾ç½®</h2>
            
            <div style="display: flex; align-items: center;">
                <button id="defaultCloseBtn" class="btn btn-close-green" onclick="checkAndClose()">ğŸ’¾ ä¿å­˜ / å…³é—­</button>
            </div>
        </div>

        <div class="manage-section section-brand">
            <h3>ğŸ·ï¸ å“ç‰Œåˆ—è¡¨</h3>
            <div id="brandTags" class="brand-tags-container"></div>
            <div style="font-size: 0.8rem; color: #9ca3af; margin-top: 10px;">æç¤ºï¼šç‚¹å‡» "+" æ·»åŠ æ–°å“ç‰Œï¼Œæ‹–åŠ¨æ’åº</div>
        </div>

        <div class="manage-section section-product" id="productManageSection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #fed7aa; padding-bottom: 10px; margin-bottom: 10px;">
                <h3 style="margin:0; padding:0; border:none;"><span id="currentSettingBrandName" style="color:#2563eb"></span></h3>
                
                <div class="item-actions-wrapper">
                    <div id="brandDefaultActions" style="display: block;">
                         <button class="btn btn-more" onclick="toggleActionMenu(this)" style="display: inline-block;">â‹®</button>
                         <div class="action-menu" style="display: none;">
                             <button class="btn btn-edit" onclick="renameCurrentBrand()">âœï¸</button>
                             <button class="btn btn-danger" onclick="showDeleteBrandConfirm()">ğŸ—‘ï¸</button>
                             <button class="btn btn-cancel-mini" onclick="closeActionMenu(this)">â–¶ï¸</button>
                         </div>
                    </div>
                    
                    <div id="brandDeleteConfirm" class="inline-confirm-wrapper" style="display: none;">
                        <button class="btn btn-danger" onclick="confirmDeleteBrand()">æ˜¯</button>
                        <button class="btn btn-cancel-mini" onclick="cancelDeleteBrand()">å¦</button>
                        <span class="inline-confirm-text">ç¡®å®šåˆ é™¤æ­¤å“ç‰Œ?</span>
                    </div>
                </div>
            </div>

            <select id="settingBrandSelect" onchange="loadProductsForSetting()"></select>
            
            <ul id="productListManage" class="list-group"></ul>
            
            <div class="flex-row">
                <textarea id="newProductName" class="bulk-input" placeholder="è¾“å…¥å•†å“åç§° æ”¯æŒæ‰¹é‡æ·»åŠ ï¼šä¸€è¡Œä¸€ä¸ªå•†å“"></textarea>
                <button class="btn btn-add" onclick="addProduct()">æ·»åŠ <br>å•†å“</button>
            </div>
        </div>

        <button class="btn btn-advanced" onclick="openAdvancedSettings()">ğŸ› ï¸ é«˜çº§åŠŸèƒ½ / æ•°æ®ç®¡ç†</button>
    </div>
</div>

<div id="advancedSettingsModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <h3>ğŸ› ï¸ é«˜çº§è®¾ç½®</h3>
        
        <div class="advanced-section">
            <span class="advanced-title">ğŸ“‚ é…ç½®ç®¡ç†</span>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-export-local" style="flex:1" onclick="exportLocalConfig()">ğŸ“¤ å¯¼å‡ºé…ç½®</button>
                <button class="btn btn-cloud-load" style="flex:1" onclick="showVersionSelector()">â˜ï¸ åŠ è½½/å†å²</button>
            </div>
        </div>

        <div class="advanced-section">
            <span class="advanced-title">ğŸ”’ è®¿é—®å¯†ç ä¿æŠ¤</span>
            <div style="font-size:0.85rem; color:#666; margin-bottom:8px;">è®¾ç½®åï¼Œè¿›å…¥è®¾ç½®é¡µé¢éœ€è¦éªŒè¯å¯†ç ã€‚ç•™ç©ºä¿å­˜åˆ™å–æ¶ˆå¯†ç ã€‚</div>
            <div class="password-row">
                <input type="text" id="settingPasswordInput" placeholder="è¾“å…¥æ–°å¯†ç ...">
                <button class="btn btn-save-mini" onclick="savePasswordProtection()">ä¿å­˜å¯†ç </button>
            </div>
        </div>

        <button class="btn btn-cancel" style="width:100%; margin-top:10px;" onclick="document.getElementById('advancedSettingsModal').style.display='none'">å…³é—­</button>
    </div>
</div>

<div id="passwordCheckModal" class="modal">
    <div class="modal-content" style="max-width: 350px; text-align: center;">
        <h3>ğŸ”’ éœ€è¦éªŒè¯å¯†ç </h3>
        <p>è¯·å…ˆè¾“å…¥å¯†ç ä»¥è¿›å…¥è®¾ç½®é¡µé¢</p>
        <input type="password" id="passwordCheckInput" style="margin-bottom: 15px; text-align: center;">
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="verifyPassword()">éªŒè¯</button>
            <button class="btn btn-cancel" onclick="closePasswordCheck()">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div id="versionSelectModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div id="versionLoadingState" class="loading-container" style="display:none">
            <div class="spinner"></div>
            <div class="loading-text">æ­£åœ¨è·å–äº‘ç«¯é…ç½®...</div>
            <button class="btn btn-cancel" onclick="cancelCurrentTask()">å–æ¶ˆ</button>
        </div>

        <div id="versionListState">
            <h3>ğŸ•’ é€‰æ‹©è¦åŠ è½½çš„é…ç½®ç‰ˆæœ¬</h3>
            <ul id="versionList" class="version-list"></ul>
            
            <button class="btn btn-import-local" onclick="document.getElementById('configFileInput').click()">ğŸ“‚ å¯¼å…¥æœ¬åœ°é…ç½®</button>
            <div style="font-size:0.8rem; color:#999; margin-top:5px; text-align:center;">æ”¯æŒå¯¼å…¥ .json æ ¼å¼çš„é…ç½®æ–‡ä»¶</div>
            
            <button class="btn btn-cancel" style="width:100%; margin-top:15px;" onclick="document.getElementById('versionSelectModal').style.display='none'">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div id="saveProcessModal" class="modal">
    <div class="modal-content" style="max-width: 300px;">
        <div class="loading-container">
            <div class="spinner"></div>
            <div class="loading-text">æ­£åœ¨ä¿å­˜åˆ°äº‘ç«¯...</div>
            <button class="btn btn-cancel" onclick="cancelCurrentTask()">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div id="logModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <h3>ğŸ“œ ä¿®æ”¹æ—¥å¿— <span id="logBaseTime" style="font-size:0.8rem; color:#999; font-weight:normal; margin-left:10px;"></span></h3>
        <ul id="logList"></ul>
        <button class="btn btn-cancel" style="width:100%; margin-top:15px;" onclick="document.getElementById('logModal').style.display='none'">å…³é—­</button>
    </div>
</div>

<div id="customDialogModal" class="modal">
    <div class="modal-content custom-dialog-content">
        <div id="dialogTitle" class="dialog-title">æç¤º</div>
        <input type="text" id="dialogInput" class="dialog-input" style="display:none;">
        <div class="dialog-btns">
            <button id="dialogBtnConfirm" class="btn btn-primary">ç¡®å®š</button>
            <button id="dialogBtnCancel" class="btn btn-cancel">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div id="imgModal" onclick="this.style.display='none'">
    <img id="imgModalContent">
</div>
<input type="file" id="hiddenFileInput" accept="image/*" style="display:none">
<input type="file" id="configFileInput" accept=".json" style="display:none" onchange="handleConfigImport(this)">

<script>
    // ============================================
    // è¯·åœ¨æ­¤å¤„å¡«å†™æ‚¨çš„ SUPABASE é…ç½®ä¿¡æ¯
    // ============================================
    const SUPABASE_URL = 'https://xlutfzstdxltvasnjmzq.supabase.co'; // ä¾‹å¦‚: https://xyz.supabase.co
    const SUPABASE_KEY = 'sb_publishable_bevWIETQac-lS6wQ7OnUnQ_DGbMmYvu'; // ä»¥ eyJ å¼€å¤´çš„é•¿å­—ç¬¦ä¸²
    const BUCKET_NAME = 'Hysl-sp-imgs'; // å­˜å‚¨æ¡¶åç§°
    // ============================================
    
    let supabaseClient = null;
    if (typeof window.supabase !== 'undefined' && SUPABASE_URL.indexOf('æ‚¨çš„_') === -1) {
        try {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch(e) { console.error("Supabase åˆå§‹åŒ–å¤±è´¥:", e); }
    }

    let inventoryData = {};
    let brandOrder = [];
    let inventoryImages = {};
    let changeLog = []; 
    let sessionCounts = {};
    let settingsPassword = ""; 

    const STORAGE_KEY = 'inventory_session_counts';

    let remoteFullData = { active: null, history: [] }; 
    let lastSyncedHash = "";
    let isHistoryLoaded = false;
    let currentBaseVersionTime = "åˆå§‹çŠ¶æ€";

    let currentBrand = "";
    let currentSettingBrand = "";
    let brandSortable = null;
    let productSortable = null;
    let isAddingBrandLock = false;
    
    // Cancellation Flag
    let taskAbortFlag = false;

    // --- UI Helpers ---
    function showToast(msg, type = 'success') {
        const container = document.getElementById('toastContainer');
        const div = document.createElement('div');
        div.className = `toast-msg ${type === 'error' ? 'toast-error' : 'toast-success'}`;
        div.innerHTML = type === 'error' ? `âŒ ${msg}` : `âœ… ${msg}`;
        container.appendChild(div);
        setTimeout(() => { div.remove(); }, 3000);
    }

    function showCustomConfirm(msg, onConfirm) {
        const modal = document.getElementById('customDialogModal');
        document.getElementById('dialogTitle').innerHTML = msg;
        document.getElementById('dialogInput').style.display = 'none';
        modal.style.display = 'flex';
        
        const confirmBtn = document.getElementById('dialogBtnConfirm');
        const newConfirm = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirm, confirmBtn);
        
        newConfirm.onclick = () => {
            modal.style.display = 'none';
            if (onConfirm) onConfirm();
        };
        
        const cancelBtn = document.getElementById('dialogBtnCancel');
        cancelBtn.onclick = () => modal.style.display = 'none';
    }

    function showCustomPrompt(title, defaultValue, onConfirm) {
        const modal = document.getElementById('customDialogModal');
        const input = document.getElementById('dialogInput');
        document.getElementById('dialogTitle').innerText = title;
        input.style.display = 'block';
        input.value = defaultValue || '';
        modal.style.display = 'flex';
        input.focus();
        
        const confirmBtn = document.getElementById('dialogBtnConfirm');
        const newConfirm = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirm, confirmBtn);
        
        const doSubmit = () => {
            const val = input.value.trim();
            if (val) {
                modal.style.display = 'none';
                if (onConfirm) onConfirm(val);
            }
        };

        newConfirm.onclick = doSubmit;
        input.onkeypress = (e) => { if (e.key === 'Enter') doSubmit(); };
        const cancelBtn = document.getElementById('dialogBtnCancel');
        cancelBtn.onclick = () => modal.style.display = 'none';
    }

    window.onload = function() {
        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        document.getElementById('globalLoader').style.display = 'flex';

        const savedSession = localStorage.getItem(STORAGE_KEY);
        if (savedSession) {
            try { sessionCounts = JSON.parse(savedSession); } catch(e) {}
        }
        renderBrandSelects();
        
        // å¦‚æœæœ‰Supabaseï¼Œåˆ™åŠ è½½æ•°æ®ï¼Œå¦åˆ™éšè—åŠ¨ç”»
        if (supabaseClient) {
            silentLoadLatest();
        } else {
            document.getElementById('globalLoader').style.display = 'none';
        }
        
        document.getElementById('hiddenFileInput').addEventListener('change', handleFileSelect);
        initDragDrop();
        
        document.getElementById('passwordCheckInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') verifyPassword();
        });
    };

    function initDragDrop() {
        const title = document.getElementById('settingsTitle');
        const targetBtn = document.getElementById('defaultCloseBtn');
        title.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', 'log_export'); e.dataTransfer.effectAllowed = 'copy'; });
        targetBtn.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; targetBtn.classList.add('drag-over'); targetBtn.innerText = "ğŸ“¥ å¯¼å‡ºæ—¥å¿—"; });
        targetBtn.addEventListener('dragleave', (e) => { targetBtn.classList.remove('drag-over'); targetBtn.innerText = "ğŸ’¾ ä¿å­˜ / å…³é—­"; });
        targetBtn.addEventListener('drop', (e) => {
            e.preventDefault(); targetBtn.classList.remove('drag-over'); targetBtn.innerText = "ğŸ’¾ ä¿å­˜ / å…³é—­";
            if (e.dataTransfer.getData('text/plain') === 'log_export') exportChangeLog();
        });
    }

    // ä¿®æ”¹ç‚¹3ï¼šå®æ—¶æ£€æµ‹å˜åŠ¨å‡½æ•°
    function checkForChanges() {
        // è®¡ç®—å½“å‰æ•°æ®çš„å“ˆå¸Œ
        const currentHash = JSON.stringify({ d: inventoryData, o: brandOrder, i: inventoryImages, p: settingsPassword });
        const floatBar = document.getElementById('unsavedFloatBar');
        
        // å¦‚æœå½“å‰å“ˆå¸Œä¸ä¸Šæ¬¡åŒæ­¥çš„å“ˆå¸Œä¸ä¸€è‡´ï¼Œä¸”æ²¡æœ‰åŠ è½½å†å²å­˜æ¡£ï¼Œåˆ™æ˜¾ç¤ºæ‚¬æµ®æ¡
        if (currentHash !== lastSyncedHash && !isHistoryLoaded) {
            floatBar.style.display = 'flex';
        } else {
            floatBar.style.display = 'none';
        }
    }

    function cancelCurrentTask() {
        taskAbortFlag = true;
        document.getElementById('versionSelectModal').style.display = 'none';
        document.getElementById('saveProcessModal').style.display = 'none';
        showToast("æ“ä½œå·²å–æ¶ˆ");
    }

    function exportChangeLog() {
        let allLogs = [];
        if (remoteFullData.history && remoteFullData.history.length > 0) {
            remoteFullData.history.slice().reverse().forEach((ver, idx) => {
                const logs = ver.data.changeLog || [];
                if (logs.length > 0) {
                    allLogs.push(`\n--- å†å²å­˜æ¡£ (${ver.time}) ---`);
                    logs.forEach(l => allLogs.push(`[${l.time}] ${l.msg}`));
                }
            });
        }
        if (remoteFullData.active && remoteFullData.active.data.changeLog && remoteFullData.active.data.changeLog.length > 0) {
            allLogs.push(`\n--- æœ€æ–°å·²ä¿å­˜ç‰ˆæœ¬ (${remoteFullData.active.time}) ---`);
            remoteFullData.active.data.changeLog.forEach(l => allLogs.push(`[${l.time}] ${l.msg}`));
        }
        if (changeLog && changeLog.length > 0) {
            allLogs.push(`\n--- å½“å‰æœªä¿å­˜ä¼šè¯ ---`);
            changeLog.forEach(l => allLogs.push(`[${l.time}] ${l.msg}`));
        }

        if (allLogs.length === 0) return showToast("æš‚æ— æ“ä½œæ—¥å¿—", "error");
        
        const content = "=== æ€»æ“ä½œæ—¥å¿— (æ—¶é—´çº¿å€’åº) ===\n" + allLogs.join("\n");
        const blob = new Blob([content], { type: 'text/plain' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `æ€»æ“ä½œæ—¥å¿—_${new Date().toISOString().slice(0,10)}.txt`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        showToast("æ€»æ—¥å¿—å·²å¯¼å‡º");
    }

    function exportLocalConfig() {
        const config = { inventoryData, brandOrder, inventoryImages, changeLog, settingsPassword, exportedAt: new Date().toLocaleString() };
        const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `ç›˜ç‚¹é…ç½®å¤‡ä»½_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function handleConfigImport(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const config = JSON.parse(e.target.result);
                if (!config.inventoryData) throw new Error("æ— æ•ˆçš„é…ç½®æ–‡ä»¶æ ¼å¼");
                showCustomConfirm(`å‡†å¤‡å¯¼å…¥é…ç½® (å¯¼å‡ºæ—¶é—´: ${config.exportedAt || 'æœªçŸ¥'})ï¼Œè¿™å°†è¦†ç›–å½“å‰è®¾ç½®ï¼Œç¡®å®šå—ï¼Ÿ`, () => {
                    inventoryData = config.inventoryData || {};
                    if(config.brandOrder) brandOrder = config.brandOrder; else brandOrder = Object.keys(inventoryData);
                    inventoryImages = config.inventoryImages || {};
                    changeLog = config.changeLog || [];
                    settingsPassword = config.settingsPassword || "";
                    
                    currentBaseVersionTime = config.exportedAt || "æœ¬åœ°å¯¼å…¥";
                    renderBrandSelects();
                    document.getElementById('versionSelectModal').style.display = 'none';
                    document.getElementById('advancedSettingsModal').style.display = 'none';
                    if(document.getElementById('settingsModal').style.display === 'flex') {
                        renderBrandTags();
                        if(currentSettingBrand) { if(inventoryData[currentSettingBrand]) loadProductsForSetting(); else selectSettingBrand(""); }
                    }
                    showToast("é…ç½®å¯¼å…¥æˆåŠŸï¼è¯·è®°å¾—ä¿å­˜åˆ°äº‘ç«¯ã€‚");
                    checkForChanges(); // æ£€æµ‹å˜åŠ¨
                });
            } catch (err) { showToast("å¯¼å…¥å¤±è´¥: " + err.message, "error"); }
        };
        reader.readAsText(file);
        input.value = ''; 
    }

    function logAction(msg) {
        const now = new Date();
        const timeStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes()}`;
        changeLog.unshift({ time: timeStr, msg: msg });
        if(changeLog.length > 200) changeLog.pop();
        
        // ä¿®æ”¹ç‚¹3ï¼šæ¯æ¬¡è®°å½•æ“ä½œåï¼Œæ£€æµ‹å˜åŠ¨
        checkForChanges();
    }
    
    function checkAndClose() {
        // è¿™é‡Œå¯ä»¥ä¿ç•™ä½œä¸ºå…³é—­æŒ‰é’®çš„é€»è¾‘
        // å› ä¸ºå·²ç»æœ‰äº†å®æ—¶æ£€æµ‹ï¼Œè¿™é‡Œä¸»è¦è´Ÿè´£å…³é—­
        const currentHash = JSON.stringify({ d: inventoryData, o: brandOrder, i: inventoryImages, p: settingsPassword });
        if (currentHash !== lastSyncedHash) {
            // å¦‚æœè¿˜æœ‰æœªä¿å­˜çš„å˜åŠ¨ï¼Œè¿™é‡Œè¿˜æ˜¯å¯ä»¥æé†’ä¸€ä¸‹ï¼Œæˆ–è€…ç›´æ¥å…³é—­è®©åº•éƒ¨çš„æ¡ä¸€ç›´æ˜¾ç¤º
            // ç°åœ¨çš„éœ€æ±‚æ˜¯åº•éƒ¨æ¡å®æ—¶æ˜¾ç¤ºï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ç›´æ¥å¼ºåˆ¶å…³é—­ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œ
            // ä½†ä¸ºäº†é˜²æ­¢è¯¯æ“ä½œï¼Œå¦‚æœç”¨æˆ·æ‰‹åŠ¨ç‚¹å…³é—­ï¼Œè¿˜æ˜¯å¼¹ä¸ªçª—é—®ä¸€ä¸‹æˆ–è€…ç›´æ¥ä¿å­˜å¹¶å…³é—­æ›´å¥½ï¼Ÿ
            // ä¿æŒåŸé€»è¾‘ï¼šå¦‚æœæœ‰å˜åŠ¨æé†’ï¼Œå¦åˆ™å…³é—­
            // ä¸è¿‡è¿™æ¬¡æˆ‘ä»¬ç®€å•ç‚¹ï¼šç›´æ¥å…³é—­ï¼Œå¦‚æœæœ‰å˜åŠ¨åº•éƒ¨çš„æ¡ä¼šåœ¨ã€‚
            // ä½†ç”¨æˆ·ä½“éªŒä¸Šï¼Œç‚¹äº†ä¿å­˜/å…³é—­ï¼Œåº”è¯¥æœŸæœ›ä¿å­˜ã€‚
            // è®©æˆ‘ä»¬è°ƒç”¨ä¿å­˜å¹¶å…³é—­
             saveSettingsToCloud(true);
        } else { 
            forceCloseSettings(); 
        }
    }

    function forceCloseSettings() {
        document.getElementById('settingsModal').style.display = 'none';
        // éšè—åº•éƒ¨æ¡ï¼ˆè™½ç„¶å¦‚æœæ²¡å˜åŠ¨æœ¬æ¥å°±æ˜¯éšè—çš„ï¼‰
        isHistoryLoaded = false; 
        renderBrandSelects();
        if(currentBrand && !inventoryData[currentBrand]) { currentBrand = ""; document.getElementById('brandSelect').value = ""; toggleInventorySection(); }
        else if (currentBrand) loadProducts(); 
    }

    async function silentLoadLatest() {
        try {
            const { data } = await supabaseClient.from('hysl-ckpd-data').select('setting_value').eq('setting_key', 'main_data').single();
            if (data && data.setting_value) {
                processRemoteData(data.setting_value);
                applyDataToApp(remoteFullData.active.data);
                currentBaseVersionTime = remoteFullData.active.time || "æœªçŸ¥ç‰ˆæœ¬";
                lastSyncedHash = JSON.stringify({ d: inventoryData, o: brandOrder, i: inventoryImages, p: settingsPassword });
                isHistoryLoaded = false;
            }
        } catch (e) { 
            console.error("Auto load failed", e); 
        } finally {
            // ä¿®æ”¹ç‚¹2ï¼šåŠ è½½ç»“æŸï¼Œéšè—é®ç½©
            document.getElementById('globalLoader').style.display = 'none';
        }
    }

    function processRemoteData(jsonValue) {
        if (jsonValue.active && Array.isArray(jsonValue.history)) remoteFullData = jsonValue;
        else remoteFullData = { active: { time: new Date().toLocaleString(), data: jsonValue }, history: [] };
    }

    function renderVersionList() {
        const list = document.getElementById('versionList');
        list.innerHTML = '';
        const active = remoteFullData.active || {};
        list.innerHTML += `
            <li class="version-item">
                <div class="version-info">
                    <strong>ğŸ“Œ æœ€æ–°ç‰ˆæœ¬</strong><br>
                    <small style="color:#888">${active.time || 'æœªçŸ¥æ—¶é—´'}</small><br>
                    <span class="version-tag tag-latest">å½“å‰ä½¿ç”¨</span>
                </div>
                <div class="version-actions">
                    <button class="btn btn-apply" onclick="confirmLoadVersion('active', 0)">åº”ç”¨</button>
                    <button class="btn btn-log" onclick="viewLog('active', 0)">æ—¥å¿—</button>
                </div>
            </li>`;
        remoteFullData.history.forEach((hist, index) => {
            list.innerHTML += `
                <li class="version-item">
                    <div class="version-info">
                        <strong>ğŸ•’ å†å²å­˜æ¡£ ${index + 1}</strong><br>
                        <small style="color:#888">${hist.time || 'æœªçŸ¥æ—¶é—´'}</small><br>
                        <span class="version-tag tag-history">å†å²å­˜æ¡£</span>
                    </div>
                    <div class="version-actions">
                        <button class="btn btn-apply" onclick="confirmLoadVersion('history', ${index})">åº”ç”¨</button>
                        <button class="btn btn-log" onclick="viewLog('history', ${index})">æ—¥å¿—</button>
                        <button class="btn btn-danger" style="padding: 4px 8px; font-size:0.8rem;" onclick="deleteHistory(${index})">ğŸ—‘ï¸</button>
                    </div>
                </li>`;
        });
    }

    async function showVersionSelector() {
        if(!supabaseClient) return showToast("è¯·å…ˆé…ç½®æ•°æ®åº“", "error");
        
        taskAbortFlag = false;
        document.getElementById('versionLoadingState').style.display = 'block';
        document.getElementById('versionListState').style.display = 'none';
        document.getElementById('versionSelectModal').style.display = 'flex';
        
        try {
            const { data, error } = await supabaseClient.from('hysl-ckpd-data').select('setting_value').eq('setting_key', 'main_data').single();
            if (taskAbortFlag) return;
            if (error) throw error;
            
            processRemoteData(data.setting_value);
            renderVersionList();
            
            document.getElementById('versionLoadingState').style.display = 'none';
            document.getElementById('versionListState').style.display = 'block';
        } catch(e) { 
            if(!taskAbortFlag) {
                document.getElementById('versionSelectModal').style.display = 'none';
                showToast("è·å–å¤±è´¥: " + e.message, "error"); 
            }
        } 
    }

    function viewLog(type, index) {
        let logs = [];
        let baseTime = "";
        if (type === 'active') { 
            if (remoteFullData.active.data.changeLog) logs = remoteFullData.active.data.changeLog; 
            if (remoteFullData.active.data.baseVersionTime) baseTime = remoteFullData.active.data.baseVersionTime;
        } else { 
            if (remoteFullData.history[index].data.changeLog) logs = remoteFullData.history[index].data.changeLog; 
            if (remoteFullData.history[index].data.baseVersionTime) baseTime = remoteFullData.history[index].data.baseVersionTime;
        }
        
        document.getElementById('logBaseTime').innerText = baseTime ? `(åŸºäº: ${baseTime})` : "";
        const logList = document.getElementById('logList');
        logList.innerHTML = '';
        if (!logs || logs.length === 0) logList.innerHTML = '<li style="text-align:center; color:#999; padding:20px;">æ­¤ç‰ˆæœ¬æ— æ”¹åŠ¨è®°å½•</li>';
        else logs.forEach(log => { const li = document.createElement('li'); li.innerHTML = `<div class="log-time">${log.time}</div><div>${log.msg}</div>`; logList.appendChild(li); });
        document.getElementById('logModal').style.display = 'flex';
    }

    async function deleteHistory(index) {
        showCustomConfirm("ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡å†å²å­˜æ¡£å—ï¼Ÿ", async () => {
            const oldHistory = [...remoteFullData.history];
            remoteFullData.history.splice(index, 1);
            try {
                const { error } = await supabaseClient.from('hysl-ckpd-data').upsert({ setting_key: 'main_data', setting_value: remoteFullData });
                if (error) throw error;
                renderVersionList();
                showToast("åˆ é™¤æˆåŠŸ");
            } catch(e) {
                console.error(e);
                showToast("åˆ é™¤å¤±è´¥: " + e.message, "error");
                remoteFullData.history = oldHistory;
            }
        });
    }

    function confirmLoadVersion(type, index) {
        let targetData = null;
        if (type === 'active') { 
            targetData = remoteFullData.active.data; 
            currentBaseVersionTime = remoteFullData.active.time || "æœªçŸ¥";
            isHistoryLoaded = false; 
        } else { 
            targetData = remoteFullData.history[index].data; 
            currentBaseVersionTime = remoteFullData.history[index].time || "æœªçŸ¥";
            isHistoryLoaded = true; 
        }
        applyDataToApp(targetData);
        if (type === 'active') lastSyncedHash = JSON.stringify({ d: inventoryData, o: brandOrder, i: inventoryImages, p: settingsPassword });
        document.getElementById('versionSelectModal').style.display = 'none';
        
        // é‡æ–°æ£€æµ‹å˜åŠ¨çŠ¶æ€
        checkForChanges();

        if(document.getElementById('settingsModal').style.display === 'flex') { renderBrandTags(); if(currentSettingBrand) loadProductsForSetting(); }
        document.querySelector('#settingsModal').scrollTop = 0;
        showToast("å·²åŠ è½½é…ç½®ï¼");
    }

    function applyDataToApp(dataObj) {
        if(dataObj.inventoryData) inventoryData = dataObj.inventoryData; else inventoryData = dataObj; 
        if(dataObj.brandOrder && Array.isArray(dataObj.brandOrder)) brandOrder = dataObj.brandOrder; else brandOrder = Object.keys(inventoryData);
        brandOrder = brandOrder.filter(b => inventoryData[b] !== undefined);
        Object.keys(inventoryData).forEach(b => { if(!brandOrder.includes(b)) brandOrder.push(b); });
        
        if(dataObj.inventoryImages) inventoryImages = dataObj.inventoryImages; else inventoryImages = {};
        if (dataObj.changeLog) changeLog = dataObj.changeLog; else changeLog = [];
        if (dataObj.settingsPassword) settingsPassword = dataObj.settingsPassword; else settingsPassword = "";
        
        renderBrandSelects();
    }

    async function saveSettingsToCloud(closeAfterSave = false) {
        if (!supabaseClient) return showToast("è¯·é…ç½® Key", "error");
        
        taskAbortFlag = false;
        document.getElementById('saveProcessModal').style.display = 'flex';

        try {
            const nowTime = new Date().toLocaleString();
            const newDataPackage = { inventoryData, brandOrder, inventoryImages, changeLog, settingsPassword, baseVersionTime: currentBaseVersionTime };
            
            let newHistory = [...remoteFullData.history];
            if (remoteFullData.active) {
                let historyVersion = JSON.parse(JSON.stringify(remoteFullData.active));
                newHistory.unshift(historyVersion);
            }
            if (newHistory.length > 1) newHistory = newHistory.slice(0, 1);
            
            const finalPayload = { active: { time: nowTime, data: newDataPackage }, history: newHistory };
            const { error } = await supabaseClient.from('hysl-ckpd-data').upsert({ setting_key: 'main_data', setting_value: finalPayload });
            
            if (taskAbortFlag) return;
            if (error) throw error;

            remoteFullData = finalPayload;
            currentBaseVersionTime = nowTime; 
            // æ›´æ–°Hash
            lastSyncedHash = JSON.stringify({ d: inventoryData, o: brandOrder, i: inventoryImages, p: settingsPassword });
            changeLog = []; 
            
            isHistoryLoaded = false; 
            document.getElementById('saveProcessModal').style.display = 'none';
            showToast("ä¿å­˜æˆåŠŸï¼");
            
            // ä¿®æ”¹ç‚¹3ï¼šä¿å­˜æˆåŠŸåï¼Œé‡æ–°æ£€æµ‹ï¼ˆæ‚¬æµ®æ¡ä¼šæ¶ˆå¤±ï¼‰
            checkForChanges();

            if (closeAfterSave) forceCloseSettings();
            
        } catch (err) { 
            if (!taskAbortFlag) {
                document.getElementById('saveProcessModal').style.display = 'none';
                showToast("ä¿å­˜å¤±è´¥: " + err.message, "error"); 
            }
        } 
    }

    function switchBrand() {
        currentBrand = document.getElementById('brandSelect').value;
        document.getElementById('searchProduct').value = '';
        toggleInventorySection();
        loadProducts();
    }

    function toggleInventorySection() {
        const section = document.getElementById('inventorySection');
        section.style.display = currentBrand ? 'block' : 'none';
    }

    function onQuantityChange(input, prodName) {
        if (!currentBrand) return;
        const qty = input.value;
        if (!sessionCounts[currentBrand]) sessionCounts[currentBrand] = {};
        if (qty !== "") {
            sessionCounts[currentBrand][prodName] = qty;
            input.closest('.inventory-item').classList.add('has-data');
        } else {
            delete sessionCounts[currentBrand][prodName];
            input.closest('.inventory-item').classList.remove('has-data');
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(sessionCounts));
    }

    function handleEnterKey(e, input) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const allInputs = Array.from(document.querySelectorAll('#productList input'));
            const idx = allInputs.indexOf(input);
            if (idx > -1 && idx < allInputs.length - 1) {
                allInputs[idx + 1].focus();
                allInputs[idx + 1].select();
            } else { input.blur(); }
        }
    }

    function loadProducts() {
        const container = document.getElementById('productList');
        container.innerHTML = '';
        if (!currentBrand) return;
        const products = inventoryData[currentBrand] || [];
        if (products.length === 0) return container.innerHTML = '<div class="empty-state">è¯¥å“ç‰Œä¸‹æš‚æ— å•†å“ï¼Œè¯·å»è®¾ç½®ä¸­æ·»åŠ </div>';

        products.forEach((prod) => {
            const div = document.createElement('div');
            div.className = 'inventory-item';
            let val = "";
            if (sessionCounts[currentBrand] && sessionCounts[currentBrand][prod] !== undefined) {
                val = sessionCounts[currentBrand][prod];
                div.classList.add('has-data');
            }
            let imgHTML = '<div class="prod-thumb-placeholder">æ— å›¾</div>';
            if (inventoryImages[currentBrand] && inventoryImages[currentBrand][prod]) {
                const src = inventoryImages[currentBrand][prod];
                imgHTML = `<img src="${src}" class="prod-thumb" onclick="showBigImage('${src}')">`;
            }
            div.innerHTML = `
                <div class="item-info">${imgHTML}<span class="item-name">${prod}</span></div>
                <div class="item-input">
                    <input type="number" data-name="${prod}" min="0" placeholder="-" value="${val}" oninput="onQuantityChange(this, '${prod}')" onkeypress="handleEnterKey(event, this)">
                </div>
            `;
            container.appendChild(div);
        });
    }

    function filterProducts() {
        const filterText = document.getElementById('searchProduct').value.toLowerCase();
        document.querySelectorAll('.inventory-item').forEach(item => {
            const name = item.querySelector('.item-name').textContent.toLowerCase();
            item.style.display = name.includes(filterText) ? 'flex' : 'none';
        });
    }

    function showClearConfirm() {
        document.getElementById('preClearBtn').style.display = 'none';
        document.getElementById('clearConfirmArea').style.display = 'flex';
        document.getElementById('clearConfirmArea').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function cancelClear() {
        document.getElementById('clearConfirmArea').style.display = 'none';
        document.getElementById('preClearBtn').style.display = 'block';
    }

    function executeClear() {
        sessionCounts = {};
        localStorage.clear();
        if(currentBrand) loadProducts();
        cancelClear();
        showToast("å·²æ¸…ç©ºï¼Œå¯ä»¥å¼€å§‹æ–°çš„ç›˜ç‚¹ã€‚");
    }

    function exportAllBrands() {
        if (typeof XLSX === 'undefined') return showToast("é”™è¯¯ï¼šæ’ä»¶åŠ è½½å¤±è´¥", "error");
        const brandsToExport = Object.keys(sessionCounts);
        const validBrands = brandsToExport.filter(brand => sessionCounts[brand] && Object.values(sessionCounts[brand]).some(v => v !== ""));
        if (validBrands.length === 0) return showToast("å°šæœªå¡«å†™ä»»ä½•ç›˜ç‚¹æ•°æ®", "error");

        try {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([]);
            const now = new Date();
            const dateShort = (now.getMonth() + 1) + "/" + now.getDate();
            let startCol = 0; let maxRows = 0; const colsWidths = [];

            validBrands.forEach(brand => {
                const blockData = [];
                blockData.push([`${brand}(${dateShort})`, ""]);
                blockData.push(["", ""]);
                blockData.push(["å“å", "åº“å­˜"]);
                const allProds = inventoryData[brand] || [];
                allProds.forEach(prodName => {
                    let qty = sessionCounts[brand] && sessionCounts[brand][prodName] !== undefined ? parseInt(sessionCounts[brand][prodName]) : "";
                    blockData.push([prodName, qty]);
                });
                XLSX.utils.sheet_add_aoa(ws, blockData, { origin: { r: 0, c: startCol } });
                colsWidths[startCol] = { wch: 20 }; colsWidths[startCol + 1] = { wch: 5 }; colsWidths[startCol + 2] = { wch: 30 }; 
                if (blockData.length > maxRows) maxRows = blockData.length;
                startCol += 3; 
            });
            ws['!cols'] = colsWidths;
            const rows = []; for(let i=0; i < maxRows; i++) rows.push({ hpx: 18 }); ws['!rows'] = rows;
            XLSX.utils.book_append_sheet(wb, ws, "ç›˜ç‚¹æ±‡æ€»");
            const timeStr = now.getFullYear() + "-" + (now.getMonth()+1) + "-" + now.getDate();
            XLSX.writeFile(wb, `åº“å­˜ç›˜ç‚¹æ±‡æ€»_${timeStr}.xlsx`);
            
            showCustomConfirm("å·²å¯¼å‡ºï¼Œè¯·æŸ¥çœ‹ä¸‹è½½æ–‡ä»¶ï¼<br>æ˜¯å¦æ¸…ç©ºç›˜ç‚¹æ•°é‡ï¼Ÿ", () => {
                sessionCounts = {}; localStorage.removeItem(STORAGE_KEY);
                if(currentBrand) loadProducts();
                showToast("æ•°æ®å·²æ¸…ç©ºï¼Œå¯å¼€å§‹æ–°ç›˜ç‚¹ã€‚");
            });
            
        } catch (error) { console.error(error); showToast("å¯¼å‡ºå¤±è´¥ï¼š" + error.message, "error"); }
    }

    function checkPasswordAndOpen() {
        if (settingsPassword && settingsPassword.trim() !== "") {
            document.getElementById('passwordCheckModal').style.display = 'flex';
            document.getElementById('passwordCheckInput').value = '';
            document.getElementById('passwordCheckInput').focus();
        } else {
            openSettings();
        }
    }

    function verifyPassword() {
        const input = document.getElementById('passwordCheckInput').value;
        if (input === settingsPassword) {
            document.getElementById('passwordCheckModal').style.display = 'none';
            openSettings();
        } else {
            showToast("å¯†ç é”™è¯¯", "error");
        }
    }

    function closePasswordCheck() {
        document.getElementById('passwordCheckModal').style.display = 'none';
    }

    function openSettings() {
        document.getElementById('settingsModal').style.display = 'flex';
        // ä¸å†éšè—unsavedAlertï¼Œå› ä¸ºå®ƒå·²ç»è¢«ç§»é™¤äº†
        renderBrandTags();
        const brandListEl = document.getElementById('brandTags');
        if(!brandSortable && typeof Sortable !== 'undefined') {
            brandSortable = new Sortable(brandListEl, { animation: 150, ghostClass: 'blue-background-class', filter: '.brand-input-tag', preventOnFilter: false, onEnd: reorderBrands });
        }
        if(currentSettingBrand) selectSettingBrand(currentSettingBrand);
        else document.getElementById('productManageSection').style.display = 'none';
        
        // æ‰“å¼€è®¾ç½®é¡µæ—¶ä¹Ÿæ£€æŸ¥ä¸€ä¸‹
        checkForChanges();
    }

    function openAdvancedSettings() {
        document.getElementById('advancedSettingsModal').style.display = 'flex';
        document.getElementById('settingPasswordInput').value = settingsPassword;
    }

    function savePasswordProtection() {
        const newVal = document.getElementById('settingPasswordInput').value.trim();
        if (newVal !== settingsPassword) {
            settingsPassword = newVal;
            logAction(newVal ? "è®¾ç½®/ä¿®æ”¹äº†è®¿é—®å¯†ç " : "å–æ¶ˆäº†è®¿é—®å¯†ç ");
            showToast(newVal ? "å¯†ç å·²ä¿å­˜ (è¯·è®°å¾—ä¿å­˜åˆ°äº‘ç«¯ç”Ÿæ•ˆ)" : "å¯†ç ä¿æŠ¤å·²å–æ¶ˆ");
            // ä¿®æ”¹ç‚¹3ï¼šå¯†ç å˜æ›´ä¹Ÿè§¦å‘æ£€æµ‹
            checkForChanges();
        } else {
            showToast("å¯†ç æœªå˜æ›´");
        }
    }

    function renderBrandSelects() {
        const brands = Object.keys(inventoryData);
        const mainSelect = document.getElementById('brandSelect');
        const settingSelect = document.getElementById('settingBrandSelect');
        const currentMainVal = mainSelect.value;
        let optionsHTML = '<option value="">-- è¯·é€‰æ‹©å“ç‰Œ --</option>';
        brandOrder.forEach(b => { 
            if(inventoryData[b] !== undefined) optionsHTML += `<option value="${b}">${b}</option>`; 
        });
        mainSelect.innerHTML = optionsHTML; settingSelect.innerHTML = optionsHTML;
        if(brandOrder.includes(currentMainVal)) mainSelect.value = currentMainVal;
        if(document.getElementById('settingsModal').style.display === 'flex') renderBrandTags();
        toggleInventorySection();
    }

    function renderBrandTags() {
        const container = document.getElementById('brandTags');
        container.innerHTML = '';
        brandOrder.forEach(brand => {
            if(inventoryData[brand] !== undefined) {
                const tag = document.createElement('div');
                tag.className = 'brand-tag'; tag.innerText = brand; tag.setAttribute('data-brand', brand);
                if (brand === currentSettingBrand) tag.classList.add('active');
                tag.onclick = function() { selectSettingBrand(brand); };
                container.appendChild(tag);
            }
        });
        const input = document.createElement('input');
        input.type = 'text'; input.id = 'newBrandInput'; input.className = 'brand-input-tag'; input.placeholder = '+';
        input.addEventListener('keypress', function(e) { if (e.key === 'Enter') addBrand(); });
        input.addEventListener('blur', function() { addBrand(); });
        container.appendChild(input);
    }

    function selectSettingBrand(brand) {
        currentSettingBrand = brand;
        const sel = document.getElementById('settingBrandSelect');
        if(sel) sel.value = brand;
        const oldInput = document.getElementById('newBrandInput');
        let isFocus = oldInput ? (document.activeElement === oldInput) : false;
        renderBrandTags();
        if(isFocus) document.getElementById('newBrandInput')?.focus();
        if (brand) {
            document.getElementById('productManageSection').style.display = 'block';
            document.getElementById('currentSettingBrandName').innerText = brand;
            cancelDeleteBrand();
            loadProductsForSetting();
        } else { document.getElementById('productManageSection').style.display = 'none'; }
    }

    function addBrand() {
        if(isAddingBrandLock) return;
        const input = document.getElementById('newBrandInput');
        if(!input) return;
        const name = input.value.trim();
        if (!name) return;
        if (Object.prototype.hasOwnProperty.call(inventoryData, name)) return showToast("å“ç‰Œåç§°å·²å­˜åœ¨", "error");
        isAddingBrandLock = true;
        inventoryData[name] = [];
        brandOrder.push(name);
        logAction(`æ·»åŠ å“ç‰Œ: ${name}`);
        renderBrandSelects(); renderBrandTags(); selectSettingBrand(name);
        setTimeout(() => { document.getElementById('newBrandInput')?.focus(); isAddingBrandLock = false; }, 300);
    }

    function showDeleteBrandConfirm() {
        document.getElementById('brandDefaultActions').style.display = 'none';
        document.getElementById('brandDeleteConfirm').style.display = 'flex';
    }

    function cancelDeleteBrand() {
        document.getElementById('brandDeleteConfirm').style.display = 'none';
        document.getElementById('brandDefaultActions').style.display = 'block';
        const menuBtn = document.querySelector('#brandDefaultActions .btn-more');
        const menu = document.querySelector('#brandDefaultActions .action-menu');
        menuBtn.style.display = 'inline-block';
        menu.style.display = 'none';
    }

    function confirmDeleteBrand() {
        const brand = currentSettingBrand;
        if (!brand) return;
        delete inventoryData[brand];
        brandOrder = brandOrder.filter(b => b !== brand);
        if(inventoryImages[brand]) delete inventoryImages[brand];
        if(sessionCounts[brand]) delete sessionCounts[brand];
        logAction(`åˆ é™¤å“ç‰Œ: ${brand}`);
        currentSettingBrand = "";
        renderBrandSelects(); renderBrandTags();
        document.getElementById('productManageSection').style.display = 'none';
        cancelDeleteBrand();
        if(currentBrand === brand) { currentBrand = ""; document.getElementById('brandSelect').value = ""; toggleInventorySection(); }
    }

    function renameCurrentBrand() {
        const oldName = currentSettingBrand;
        if (!oldName) return;
        showCustomPrompt("è¯·è¾“å…¥æ–°çš„å“ç‰Œåç§°", oldName, (newName) => {
            if (newName && newName !== oldName) {
                if (inventoryData[newName]) return showToast("è¯¥å“ç‰Œåç§°å·²å­˜åœ¨ï¼", "error");
                inventoryData[newName] = inventoryData[oldName]; delete inventoryData[oldName];
                const idx = brandOrder.indexOf(oldName);
                if(idx !== -1) brandOrder[idx] = newName;
                if (inventoryImages[oldName]) { inventoryImages[newName] = inventoryImages[oldName]; delete inventoryImages[oldName]; }
                if (sessionCounts[oldName]) { sessionCounts[newName] = sessionCounts[oldName]; delete sessionCounts[oldName]; }
                logAction(`é‡å‘½åå“ç‰Œ: ${oldName}->${newName}`);
                if (currentBrand === oldName) currentBrand = newName;
                renderBrandSelects(); selectSettingBrand(newName);
            }
        });
    }

    function reorderBrands() {
        const tags = document.querySelectorAll('#brandTags .brand-tag');
        const newOrder = [];
        tags.forEach(tag => {
            const name = tag.getAttribute('data-brand');
            if (name) newOrder.push(name);
        });
        brandOrder = newOrder;
        renderBrandSelects();
        logAction("è°ƒæ•´å“ç‰Œæ’åº");
    }

    function loadProductsForSetting() {
        const brand = currentSettingBrand;
        const list = document.getElementById('productListManage');
        if(productSortable) { productSortable.destroy(); productSortable = null; }
        list.innerHTML = '';
        if (!brand || !inventoryData[brand]) return list.innerHTML = '<li style="color:#888; padding:10px;">è¯·å…ˆåœ¨ä¸Šæ–¹é€‰æ‹©ä¸€ä¸ªå“ç‰Œ</li>';
        
        inventoryData[brand].forEach((prod, index) => {
            const li = document.createElement('li');
            li.setAttribute('data-prod', prod);
            let hasImg = (inventoryImages[brand] && inventoryImages[brand][prod]);
            let imgBtnStyle = hasImg ? "background-color: #22c55e;" : "";
            let imgBtnText = hasImg ? "ğŸ–¼ï¸" : "ğŸ–¼ï¸";
            let thumbTag = hasImg ? `<img src="${inventoryImages[brand][prod]}" class="setting-thumb" onclick="showBigImage('${inventoryImages[brand][prod]}')">` : '';
            let clickAction = hasImg ? `showBigImage('${inventoryImages[brand][prod]}')` : `triggerUpload('${brand}', ${index})`;
            
            li.innerHTML = `
                <div class="li-content">
                    <div class="text-wrapper" onclick="${clickAction}">
                        <span class="drag-handle">â˜°</span>${thumbTag}<span class="text-content">${prod}</span>
                    </div>
                    <div class="item-actions-wrapper">
                        <div class="action-menu-default">
                            <button class="btn btn-more" onclick="toggleActionMenu(this)">â‹®</button>
                            <div class="action-menu">
                                <button class="btn btn-img-upload" style="${imgBtnStyle}" onclick="triggerUpload('${brand}', ${index})" title="ä¸Šä¼ /ä¿®æ”¹å›¾ç‰‡">${imgBtnText}</button>
                                <button class="btn btn-edit" onclick="enableProductEdit(this, '${brand}', ${index})" title="ç¼–è¾‘">âœï¸</button>
                                <button class="btn btn-danger" onclick="showDeleteProductConfirm(this)" title="åˆ é™¤">ğŸ—‘ï¸</button>
                                <button class="btn btn-cancel-mini" onclick="closeActionMenu(this)">â–¶ï¸</button>
                            </div>
                        </div>
                        <div class="inline-confirm-wrapper">
                             <button class="btn btn-danger" onclick="confirmDeleteProduct('${brand}', ${index})">æ˜¯</button>
                             <button class="btn btn-cancel-mini" onclick="cancelDeleteProduct(this)">å¦</button>
                             <span class="inline-confirm-text">ç¡®å®šåˆ é™¤?</span>
                        </div>
                    </div>
                </div>
            `;
            list.appendChild(li);
        });
        if(typeof Sortable !== 'undefined') {
            productSortable = new Sortable(list, { animation: 150, handle: '.drag-handle', onEnd: function (evt) { reorderProducts(brand); } });
        }
    }

    function reorderProducts(brand) {
        const lis = document.querySelectorAll('#productListManage li');
        const newProducts = [];
        lis.forEach(li => { const prod = li.getAttribute('data-prod'); if(prod) newProducts.push(prod); });
        inventoryData[brand] = newProducts;
    }

    function addProduct() {
        const brand = currentSettingBrand;
        const inputVal = document.getElementById('newProductName').value;
        if (!brand) return showToast("è¯·å…ˆé€‰æ‹©å“ç‰Œ", "error");
        if (!inputVal.trim()) return showToast("è¯·è¾“å…¥å•†å“åç§°", "error");
        const newItems = inputVal.split('\n').map(item => item.trim()).filter(item => item !== "");
        newItems.forEach(name => {
            if (!inventoryData[brand].includes(name)) { inventoryData[brand].push(name); logAction(`æ·»åŠ å•†å“: ${brand}-${name}`); }
        });
        document.getElementById('newProductName').value = '';
        loadProductsForSetting();
    }

    function toggleActionMenu(btn) {
        const wrapper = btn.closest('.item-actions-wrapper');
        const menu = wrapper.querySelector('.action-menu');
        if (menu.style.display === 'flex') { menu.style.display = 'none'; btn.style.display = 'inline-block'; } 
        else {
            document.querySelectorAll('.action-menu').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.inline-confirm-wrapper').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.btn-more').forEach(el => el.style.display = 'inline-block');
            document.querySelectorAll('.action-menu-default').forEach(el => el.style.display = 'block');
            menu.style.display = 'flex'; btn.style.display = 'none';
        }
    }

    function closeActionMenu(closeBtn) {
        const wrapper = closeBtn.closest('.item-actions-wrapper');
        const menu = wrapper.querySelector('.action-menu');
        const triggerBtn = wrapper.querySelector('.btn-more');
        menu.style.display = 'none'; triggerBtn.style.display = 'inline-block';
    }

    function showDeleteProductConfirm(btn) {
        const wrapper = btn.closest('.item-actions-wrapper');
        wrapper.querySelector('.action-menu-default').style.display = 'none';
        wrapper.querySelector('.inline-confirm-wrapper').style.display = 'flex';
    }

    function cancelDeleteProduct(btn) {
        const wrapper = btn.closest('.item-actions-wrapper');
        wrapper.querySelector('.inline-confirm-wrapper').style.display = 'none';
        wrapper.querySelector('.action-menu-default').style.display = 'block';
        const menuBtn = wrapper.querySelector('.btn-more');
        const menu = wrapper.querySelector('.action-menu');
        menuBtn.style.display = 'inline-block';
        menu.style.display = 'none';
    }

    function confirmDeleteProduct(brand, index) {
        const prodName = inventoryData[brand][index];
        if (sessionCounts[brand] && sessionCounts[brand][prodName]) delete sessionCounts[brand][prodName];
        if (inventoryImages[brand] && inventoryImages[brand][prodName]) delete inventoryImages[brand][prodName];
        logAction(`åˆ é™¤å•†å“: ${brand}-${prodName}`);
        inventoryData[brand].splice(index, 1);
        loadProductsForSetting();
    }

    function enableProductEdit(btn, brand, index) {
        const li = btn.closest('li');
        const textWrapper = li.querySelector('.text-wrapper');
        const textContent = li.querySelector('.text-content');
        const oldName = textContent.innerText;
        const input = document.createElement('input');
        input.type = 'text'; input.value = oldName; input.className = 'edit-input';
        textWrapper.innerHTML = ''; textWrapper.appendChild(input); textWrapper.onclick = null; 
        input.focus(); closeActionMenu(btn);
        const saveEdit = () => {
            const newName = input.value.trim();
            if (newName && newName !== oldName) {
                inventoryData[brand][index] = newName;
                if (inventoryImages[brand] && inventoryImages[brand][oldName]) { inventoryImages[brand][newName] = inventoryImages[brand][oldName]; delete inventoryImages[brand][oldName]; }
                if (sessionCounts[brand] && sessionCounts[brand][oldName]) { sessionCounts[brand][newName] = sessionCounts[brand][oldName]; delete sessionCounts[brand][oldName]; }
                logAction(`ä¿®æ”¹å•†å“: ${oldName}->${newName}`);
            }
            loadProductsForSetting();
        };
        input.addEventListener('blur', saveEdit);
        input.addEventListener('keypress', (e) => { if (e.key === 'Enter') saveEdit(); });
    }

    let pendingUploadBrand = null;
    let pendingUploadIndex = null;
    function triggerUpload(brand, index) {
        pendingUploadBrand = brand; pendingUploadIndex = index;
        document.getElementById('hiddenFileInput').value = '';
        document.getElementById('hiddenFileInput').click();
        const lis = document.querySelectorAll('#productListManage li');
        if(lis[index]) { const closeBtn = lis[index].querySelector('.btn-cancel-mini'); if(closeBtn) closeActionMenu(closeBtn); }
    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                const maxWidth = 300; 
                const maxHeight = 300;
                let width = img.width;
                let height = img.height;
                if (width > height) {
                    if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                } else {
                    if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
                }
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                canvas.toBlob(async (blob) => {
                    const brand = pendingUploadBrand;
                    const index = pendingUploadIndex;
                    const prodName = inventoryData[brand][index];

                    if (!supabaseClient) return showToast("æœªé…ç½®æ•°æ®åº“è¿æ¥ï¼Œæ— æ³•ä¸Šä¼ ", "error");
                    
                    showToast("æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...", "success");

                    const rawName = brand + prodName;
                    
                    let pinyinArr = pinyinPro.pinyin(rawName, { 
                        pattern: 'first', 
                        toneType: 'none', 
                        type: 'array' 
                    });
                    
                    const cleanName = pinyinArr.join('').toUpperCase().replace(/[^A-Z0-9]/g, '');
                    
                    const filePath = cleanName + ".jpg";

                    const { data, error } = await supabaseClient
                        .storage
                        .from(BUCKET_NAME)
                        .upload(filePath, blob, { 
                            contentType: 'image/jpeg',
                            upsert: true 
                        });

                    if (error) {
                        console.error("ä¸Šä¼ è¯¦ç»†é”™è¯¯:", error);
                        showToast("ä¸Šä¼ å¤±è´¥: " + (error.message || error.error), "error");
                        return;
                    }

                    const { data: { publicUrl } } = supabaseClient
                        .storage
                        .from(BUCKET_NAME)
                        .getPublicUrl(filePath);

                    const finalUrl = publicUrl + "?t=" + new Date().getTime();
                    
                    if (!inventoryImages[brand]) inventoryImages[brand] = {};
                    inventoryImages[brand][prodName] = finalUrl;
                    
                    logAction(`æ›´æ–°å›¾ç‰‡: ${brand}-${prodName}`);
                    loadProductsForSetting();
                    showToast("å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼");
                    
                }, 'image/jpeg', 0.5); 
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function showBigImage(src) {
        const modal = document.getElementById('imgModal');
        const img = document.getElementById('imgModalContent');
        img.src = src;
        modal.style.display = 'flex';
    }
</script>

</body>
</html>